<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UK User Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.285.0/font/lucide.css">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(120deg, #181F2F 0%, #153448 100%);
      color: #fff;
      min-height: 100vh;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 260px;
      background: rgba(12, 23, 36, 0.92);
      backdrop-filter: blur(4px);
      border-right: 1.5px solid #263857;
      padding: 2.8rem 1.1rem 1.8rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      min-height: 100vh;
      box-shadow: 3px 0 32px #001f3f24;
      transition: left 0.35s;
      z-index: 30;
      position: relative;
    }
    .sidebar h2 {
      margin-bottom: 2.6rem;
      font-size: 2rem;
      color: #51f2d6;
      letter-spacing: 1px;
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      background: linear-gradient(90deg, #78ffd6 0%, #31c3f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .sidebar-menu {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }
    .sidebar a, .sidebar button {
      color: #fff;
      text-decoration: none;
      padding: 0.98rem 1.2rem 0.98rem 1.0rem;
      border-radius: 11px;
      background: none;
      border: none;
      text-align: left;
      cursor: pointer;
      font-family: inherit;
      font-size: 1.13rem;
      font-weight: 500;
      transition: background 0.19s, color 0.13s;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 0.85rem;
      letter-spacing: 0.5px;
      outline: none;
    }
    .sidebar a.active, .sidebar a:hover, .sidebar button.logout-btn:hover {
      background: linear-gradient(90deg,#23a6d5 0%, #23d5ab 100%);
      color: #101e2a;
    }
    .sidebar i {
      font-size: 1.25em;
      opacity: 0.74;
    }
    .main {
      flex: 1;
      padding: 2.8rem 4vw 2.2rem 4vw;
      min-width: 0;
      transition: filter 0.3s;
    }
    .header {
      background: rgba(17,36,60, 0.89);
      padding: 1.8rem 2.5rem 1.4rem 2.5rem;
      font-size: 1.77rem;
      border-radius: 20px;
      margin-bottom: 2.1rem;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      box-shadow: 0 4px 24px #04183729;
      min-height: 65px;
    }
    .hello-owner {
      font-family: 'Dancing Script', cursive;
      font-size: 2.3rem;
      color: #fffbec;
      font-weight: 700;
      letter-spacing: 1.5px;
      background: linear-gradient(90deg, #fffbe7 0%, #b3ecf7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: inline-block;
      min-height: 44px;
    }
    .subtext {
      font-size:1.19rem;
      color:#8ee8e4;
      margin-top:1.6rem;
      margin-bottom:2.2rem;
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 24px;
      align-items: center;
    }
    .filter-row label { margin-right: 4px; }
    .filter-row input, .filter-row select {
      padding: 8px 13px;
      border-radius: 7px;
      border: none;
      font-size: 1.03rem;
      background: #163453;
      color: #fff;
      outline: none;
      border: 1px solid #23d5ab25;
    }
    .filter-row select:focus, .filter-row input:focus {
      border: 1.5px solid #51f2d6;
    }
    .card-table {
      background: rgba(255,255,255,0.12);
      border-radius: 20px;
      box-shadow: 0 4px 32px #21cfc340;
      padding: 0.5rem 1.1rem 1.1rem 1.1rem;
      border: 1.5px solid rgba(55,155,255,0.09);
      min-height: 320px;
      margin-bottom: 40px;
      width: 100%;
      overflow-x: auto;
    }
    .card-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.98rem;
      color: #fff;
      margin-bottom: 0;
      background: none;
      min-width: unset;
      table-layout: auto;
    }
    thead th {
      background: rgba(10,70,120,0.14);
      color: #72ffe2;
      font-size: 0.95rem;
      padding: 0.58rem 0.5rem;
      text-align: left;
      border-bottom: 2px solid #24d8d999;
      font-weight: 700;
      letter-spacing: 1px;
      white-space: nowrap;
    }
    tbody tr {
      background: rgba(255,255,255,0.04);
      transition: background 0.13s;
    }
    tbody tr:hover {
      background: rgba(80,240,220,0.13);
    }
    td {
      padding: 0.49rem 0.5rem;
      border-bottom: 1px solid #218b9344;
      vertical-align: middle;
      font-size: 0.98rem;
      letter-spacing: 0.2px;
      line-height: 1.3;
      word-break: break-word;
      max-width: 130px;
    }
    td input[type="number"] {
      width: 80px;
      min-width: 40px;
      padding: 4px 6px;
      font-size: 1rem;
      border-radius: 7px;
      border: 1px solid #31c3f6;
      background: #0f2c48;
      color: #fff;
      outline: none;
      text-align: center;
      box-sizing: border-box;
    }
    .order-btn, .submit-btn {
      background: #3fbc5f;
      padding: 7px 21px;
      border: none;
      color: white;
      border-radius: 9px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 0;
      margin-bottom: 0;
      transition: background 0.18s;
      white-space: nowrap;
      min-width: 62px;
      font-weight: 600;
      box-shadow: 0 2px 8px #13e2c21a;
    }
    .order-btn:hover, .submit-btn:hover { background: #22b672; }
    .order-summary-section {
      background: rgba(28,60,92,0.18);
      border-radius: 14px;
      margin-top: 1.7rem;
      padding: 1rem 1.4rem 1.1rem 1.4rem;
      box-shadow: 0 2px 14px #12eab823;
    }
    .order-summary-section h3 {
      margin-top: 0;
      margin-bottom: 0.4rem;
      color: #aaf2ee;
      font-size: 1.16rem;
    }
    .order-summary-section ul {
      padding-left: 1.2rem;
      margin: 0 0 0.9rem 0;
    }
    .order-summary-section li {
      margin-bottom: 4px;
      color: #eafcff;
    }
    .hamburger {
      display: none;
      position: fixed;
      top: 70px;
      left: 20px;
      z-index: 60;
      background: rgba(36,51,77,0.97);
      border-radius: 7px;
      border: 1.5px solid #29f2d7b3;
      width: 44px;
      height: 44px;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .hamburger i {
      font-size: 2.1rem;
      color: #5fffff;
      margin: auto;
      display: block;
    }
    .sidebar.closed {
      left: -280px;
      position: fixed;
      top: 0; bottom: 0;
      min-height: 100vh;
      z-index: 50;
    }
    .sidebar.open {
      left: 0;
      position: fixed;
      top: 0; bottom: 0;
      min-height: 100vh;
      z-index: 55;
      background: rgba(12, 23, 36, 0.99);
    }
    .sidebar-backdrop {
      display: none;
    }
    @media (max-width: 1024px) {
      .main {padding: 1.2rem 0.7rem;}
      .header {font-size:1.2rem;}
      .sidebar {
        width: 180px;
        padding: 1.2rem 0.4rem 1.2rem 0.6rem;
      }
      .sidebar h2 {font-size:1.1rem;letter-spacing:0;}
      .sidebar-menu a span {display:inline;}
      .sidebar.open { width: 74vw; min-width: 168px; }
      .sidebar.closed { width: 0; min-width: 0; }
      .card-table { padding: 0.3rem; }
      .hamburger { display: flex; }
      .sidebar-backdrop {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.28);
        z-index: 40;
      }
      .sidebar.open ~ .sidebar-backdrop {
        display: block;
      }
    }
    @media (max-width: 700px) {
      .header {padding:1.1rem 0.4rem 0.7rem 1.0rem;}
      .hello-owner {font-size:1.22rem;}
      .filter-row {flex-direction:column;align-items:stretch;gap:0.6rem;}
      .card-table {padding:0.09rem;}
      .card-table table {font-size:0.91rem;}
      td, th {font-size:0.93rem;}
      td {max-width: 90px;}
      .order-btn, .submit-btn {font-size:0.97rem;padding:6px 9px;}
    }
    /* --- MOBILE: Simple responsive table --- */
    @media (max-width: 540px) {
      .card-table {
        overflow-x: auto;
        padding: 0.07rem;
      }
      .card-table table {
        min-width: 520px; /* force full table to fit horizontally */
        font-size: 0.98rem;
      }
      td, th {
        max-width: 120px;
        padding: 0.48rem 0.25rem;
        font-size: 0.98rem;
        word-break: break-word;
      }
      td input[type="number"] {
        width: 60px;
        min-width: 40px;
      }
      .order-btn {
        padding: 8px 16px;
        min-width: 50px;
        width: auto;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="hamburger" onclick="openSidebar()" id="hamburgerMenu" aria-label="Open navigation"><i class="lucide lucide-menu"></i></div>
  <div class="container">
    <nav class="sidebar closed" id="mainSidebar">
      <h2>UK User</h2>
      <div class="sidebar-menu">
        <a href="dashboard-ukuser.html" class="active"><i class="lucide lucide-home"></i><span>Dashboard</span></a>
        <a href="dashboard-uk-stock.html"><i class="lucide lucide-warehouse"></i><span>Live Stock Overview</span></a>
      </div>
      <button class="logout-btn" onclick="logout()"><i class="lucide lucide-log-out"></i> Logout</button>
    </nav>
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeSidebar()"></div>
    <main class="main" id="mainContent">
      <div class="header">
        <span class="hello-owner" id="helloOwner"></span>
      </div>
      <div class="subtext">
        Place and review your stock orders. Quickly filter products, build your order, and submit in seconds.
      </div>
      <div class="filter-row">
        <label for="searchInput">Search:</label>
        <input type="text" id="searchInput" placeholder="Search by product..." oninput="applyFilter()" />
        <label for="categoryFilter">Category:</label>
        <select id="categoryFilter" onchange="applyFilter()">
          <option value="All">All</option>
          <option value="Starter Kit">Starter Kit</option>
          <option value="Express Lash">Express Lash</option>
          <option value="Wielokrotnego">Wielokrotnego</option>
          <option value="Bio">Bio</option>
          <option value="Ribbon">Ribbon</option>
          <option value="Accessories">Accessories</option>
          <option value="Make-up">Make-up</option>
        </select>
      </div>
      <div class="card-table">
        <div style="overflow-x:auto;">
          <table id="stockTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Available</th>
                <th>Qty</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="order-summary-section">
        <h3>ðŸ›’ Order Summary</h3>
        <ul id="orderPreview"></ul>
        <button class="submit-btn" onclick="submitOrder()">âœ… Confirm and Submit Order</button>
      </div>
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Responsive sidebar logic
    function openSidebar() {
      document.getElementById('mainSidebar').classList.add('open');
      document.getElementById('mainSidebar').classList.remove('closed');
      document.getElementById('sidebarBackdrop').style.display = 'block';
      document.body.style.overflow = "hidden";
    }
    function closeSidebar() {
      document.getElementById('mainSidebar').classList.add('closed');
      document.getElementById('mainSidebar').classList.remove('open');
      document.getElementById('sidebarBackdrop').style.display = 'none';
      document.body.style.overflow = "";
    }
    // Hide sidebar by default on mobile
    function mobileSidebarInit() {
      if(window.innerWidth <= 900){
        closeSidebar();
        document.getElementById('hamburgerMenu').style.display = 'flex';
      } else {
        document.getElementById('mainSidebar').classList.remove('closed', 'open');
        document.getElementById('hamburgerMenu').style.display = 'none';
        document.getElementById('sidebarBackdrop').style.display = 'none';
      }
    }
    window.addEventListener('resize', mobileSidebarInit);
    window.addEventListener('DOMContentLoaded', mobileSidebarInit);

    // Supabase code (untouched)
    const supabase = window.supabase.createClient(
      'https://rwmwsaxlqblvnhfyuuqg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
    );

    let currentUser = null;

    // Typewriter effect for "Hello Name"
    function typeWriter(element, text, speed=60) {
      let i = 0;
      element.textContent = "";
      function typing() {
        if (i < text.length) {
          element.textContent += text.charAt(i);
          i++;
          setTimeout(typing, speed);
        }
      }
      typing();
    }

    supabase.auth.getUser().then(async ({ data: { user } }) => {
      if(!user) { window.location.href = "index.html"; return; }
      currentUser = user;
      const { data: profile } = await supabase
        .from('profiles')
        .select('name,role')
        .eq('id', user.id)
        .single();
      if(!profile || profile.role !== 'uk') {
        window.location.href = "index.html";
        return;
      }
      // Dynamic name (use profile.name or fallback to email)
      const firstName = profile.name ? profile.name.split(' ')[0] : (user.email ? user.email.split('@')[0] : "User");
      typeWriter(document.getElementById('helloOwner'), `Hello ${firstName}`);
      await logAction("Login", {});
    });

    // Audit log helper
    async function logAction(action, details) {
      if (!currentUser) return;
      await supabase.from('audit_log').insert([
        {
          user_id: currentUser.id,
          user_email: currentUser.email,
          action,
          details
        }
      ]);
    }

    let orderItems = [];

    async function fetchStock() {
      const { data, error } = await supabase
        .from('stock')
        .select('*')
        .order('name', { ascending: true });
      if (error) { console.error(error); return; }
      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = '';
      data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td data-label="Product">${item.name}</td>
          <td data-label="Category">${item.category}</td>
          <td data-label="Available">${item.qty}</td>
          <td data-label="Qty">
            <input
              type="number"
              data-id="${item.id}"
              data-name="${item.name}"
              data-cat="${item.category}"
              data-qty="${item.qty}"
              value="0"
              min="0"
              max="${item.qty}"
            />
          </td>
          <td data-label="Action"><button class="order-btn" onclick="addToOrder(this)">Add</button></td>`;
        tbody.appendChild(row);
      });
      applyFilter();
    }

    function applyFilter() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const selectedCat = document.getElementById('categoryFilter').value;
      document.querySelectorAll('#stockTable tbody tr').forEach(row => {
        const name = row.cells[0].innerText.toLowerCase();
        const cat = row.cells[1].innerText;
        row.style.display =
          ((!searchTerm || name.includes(searchTerm)) &&
           (selectedCat === 'All' || cat === selectedCat))
          ? '' : 'none';
      });
    }

    function addToOrder(button) {
      const input = button.closest('tr').querySelector('input');
      const qty = parseInt(input.value, 10);
      if (qty > 0 && qty <= +input.dataset.qty) {
        orderItems.push({
          product: input.dataset.name,
          category: input.dataset.cat,
          qty,
          stock_id: input.dataset.id,
          available: +input.dataset.qty
        });
        input.value = 0;
        updateOrderPreview();
      }
    }

    function updateOrderPreview() {
      const ul = document.getElementById('orderPreview');
      ul.innerHTML = '';
      orderItems.forEach(item => {
        ul.innerHTML += `<li>${item.product} (${item.category}) â€” Qty: ${item.qty}</li>`;
      });
    }

    async function submitOrder() {
      if (!orderItems.length) return alert('âŒ No items to submit.');
      const groupId = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2);

      // Audit log: Place Order
      await logAction("Place Order", { items: orderItems, groupId });

      for (const item of orderItems) {
        const { error } = await supabase.from('orders').insert([
          { region: 'UK', product: item.product, qty: item.qty, category: item.category, order_group_id: groupId, status: 'Pending' }
        ]);
        if (error) { alert('âŒ Failed to submit order.'); return; }
        await supabase.from('stock').update({ qty: item.available - item.qty }).eq('id', item.stock_id);
      }
      alert('âœ… Order placed!');
      orderItems = [];
      updateOrderPreview();
      fetchStock();
    }

    async function logout() {
      await logAction("Logout", {});
      await supabase.auth.signOut();
      localStorage.clear();
      sessionStorage.clear();
      setTimeout(() => window.location.href = "index.html", 300);
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchStock();
      mobileSidebarInit();
    });
  </script>
</body>
</html>
