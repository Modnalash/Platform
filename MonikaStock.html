<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monika Stock Management</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { margin:0; font-family:Segoe UI,sans-serif; background:#f7fafc; color:#222; }
    header { background:#4a76a8; color:#fff; padding:1.2rem 2rem; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:1.5rem; }
    .logout-btn { background:#f44336; border:none; color:#fff; padding:0.5rem 1.2rem; border-radius:5px; cursor:pointer; }
    .container { padding:2rem; max-width:700px; margin:2rem auto; background:#fff; border-radius:8px; box-shadow:0 2px 12px rgba(60,60,60,0.14);}
    h2 { margin-top:0; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th,td { padding:8px 12px; border:1px solid #ddd; }
    th { background:#dbeafe; }
    tr.low-stock td { background:#fff7f7; }
    input[type="number"] { width:70px; padding:4px; }
    button.update-btn { background:#4a76a8; color:#fff; border:none; padding:5px 14px; border-radius:4px; cursor:pointer; }
    button.update-btn:hover { background:#36537a; }
    .filter-row { display:flex; gap:1rem; margin-bottom:1rem; align-items:center; }
    .success { color:green; margin-left:1rem; }
    .error { color:#f44336; margin-left:1rem; }
  </style>
</head>
<body>
  <header>
    <h1>Monika Stock</h1>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>
  <div class="container">
    <h2>Stock List</h2>
    <div class="filter-row">
      <label for="searchInput">Search:</label>
      <input type="text" id="searchInput" placeholder="Product or SKU" oninput="renderTable()"/>
      <label for="categoryFilter">Category:</label>
      <select id="categoryFilter" onchange="renderTable()">
        <option value="">All</option>
      </select>
    </div>
    <table id="stockTable">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Name</th>
          <th>Category</th>
          <th>Quantity</th>
          <th>Update Qty</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="msgArea"></div>
  </div>
<script>
  const supabase = window.supabase.createClient('https://rwmwsaxlqblvnhfyuuqg.supabase.co', 
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
  );
  let currentUser = null;
  let stockData = [];
  let categories = [];

  async function logout() {
    await supabase.auth.signOut();
    localStorage.clear();
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  supabase.auth.getUser().then(async ({ data: { user } }) => {
    if (!user) return window.location.href = "index.html";
    currentUser = user;
    // Check user role - allow only Monika
    // You should enforce this in your backend as well for security
    const { data: profile } = await supabase.from('profiles').select('role,email').eq('id', user.id).single();
    if (!profile || !(profile.role === 'monika' || profile.email === 'monika@email.com')) {
      window.location.href = "index.html";
      return;
    }
    fetchStock();
  });

  async function fetchStock() {
    // Fetch only Monika's stock (assuming there is an owner_id or similar field)
    let { data, error } = await supabase.from('stock').select('*').eq('owner_id', currentUser.id).order('name', { ascending:true });
    if (error || !Array.isArray(data)) {
      document.getElementById('msgArea').innerHTML = '<span class="error">Could not fetch stock</span>';
      return;
    }
    stockData = data;
    categories = [...new Set(stockData.map(r => r.category).filter(Boolean))];
    renderCategoryFilter();
    renderTable();
  }

  function renderCategoryFilter() {
    const sel = document.getElementById('categoryFilter');
    let opts = '<option value="">All</option>';
    categories.forEach(c => opts += `<option value="${c}">${c}</option>`);
    sel.innerHTML = opts;
  }

  function renderTable() {
    const s = document.getElementById('searchInput').value.toLowerCase();
    const c = document.getElementById('categoryFilter').value;
    const tbody = document.querySelector('#stockTable tbody');
    tbody.innerHTML = '';
    stockData
      .filter(x => (x.name||'').toLowerCase().includes(s) || (x.sku||'').toLowerCase().includes(s))
      .filter(x => !c || x.category === c)
      .forEach(item => {
        const tr = document.createElement('tr');
        if (item.qty <= 10) tr.classList.add('low-stock');
        tr.innerHTML = `
          <td>${item.sku || ''}</td>
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>${item.qty}</td>
          <td>
            <input type="number" min="0" id="qty-${item.id}" value="${item.qty}" style="width:60px;">
            <button class="update-btn" onclick="updateQty('${item.id}')">Save</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
  }

  async function updateQty(id) {
    const qtyInput = document.getElementById('qty-' + id);
    const newQty = parseInt(qtyInput.value, 10);
    if (isNaN(newQty) || newQty < 0) {
      msg('Quantity must be 0 or greater', true);
      return;
    }
    // Only allow quantity update, not other fields!
    const { error } = await supabase.from('stock').update({ qty: newQty }).eq('id', id).eq('owner_id', currentUser.id);
    if (error) {
      msg('Update failed', true);
      return;
    }
    msg('Quantity updated!', false);
    fetchStock();
  }

  function msg(message, isError) {
    document.getElementById('msgArea').innerHTML = `<span class="${isError ? 'error':'success'}">${message}</span>`;
    setTimeout(() => { document.getElementById('msgArea').innerHTML = ''; }, 2000);
  }
</script>
</body>
</html>
