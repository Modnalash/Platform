<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory Valuation & Multi-Currency Report</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { margin: 0; font-family: 'Inter', sans-serif; background: #0b1c2c; color: #fff; }
    .container { max-width: 1200px; margin: auto; padding: 2rem; }
    .top-bar { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .top-bar button, .top-bar input, .top-bar select { padding: .6rem 1rem; font-size: 1rem; border: none; border-radius: 6px; }
    .top-bar input, .top-bar select { background: #15273a; color: #fff; }
    .top-bar button { background: #7ee2f6; color: #0b1c2c; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; background: #15273a; border-radius: 8px; overflow: hidden; }
    th, td { padding: .75rem 1rem; text-align: left; border-bottom: 1px solid #1e3d5e; }
    th { background: #112b44; }
    tr.low-stock { background: rgba(242, 139, 130, .2); }
    tfoot td { font-weight: bold; background: #112b44; }
    canvas { margin-top: 2rem; background: #fff; border-radius: 8px; padding: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <button onclick="location.href='dashboard-admin.html'">← Back to Dashboard</button>
      <label>FX Date:</label>
      <input type="date" id="fxDate" value="">
      <button id="loadFx">Load FX Rates</button>
      <input type="text" id="search" placeholder="Search product…" oninput="render()">
      <select id="catFilter" onchange="render()">
        <option value="">All Categories</option>
      </select>
    </div>

    <table id="report">
      <thead>
        <tr>
          <th>Product</th>
          <th>Category</th>
          <th>Qty (Admin)</th>
          <th>Qty (PL)</th>
          <th>Total Qty</th>
          <th>Cost USD</th>
          <th>Cost PLN</th>
          <th>Cost £</th>
          <th>Cost €</th>
          <th>Sell PLN</th>
          <th>Sell USD</th>
          <th>Sell £</th>
          <th>Sell €</th>
          <th>Value USD</th>
          <th>Value PLN</th>
          <th>Value £</th>
          <th>Value €</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="13">Totals:</td>
          <td id="totUsd">$0.00</td>
          <td id="totPln">0.00 PLN</td>
          <td id="totGbp">£0.00</td>
          <td id="totEur">€0.00</td>
        </tr>
      </tfoot>
    </table>

    <canvas id="chart" height="100"></canvas>
  </div>

  <script>
    const SUPABASE_URL = 'https://rwmwsaxlqblvnhfyuuqg.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y';
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

    let fx = { PLN:1, GBP:1, EUR:1 }, admin=[], pl=[];
    document.getElementById('fxDate').value = new Date().toISOString().slice(0,10);
    document.getElementById('loadFx').onclick = loadFx;

    async function loadFx() {
      const date = document.getElementById('fxDate').value;
      const res = await fetch(`https://api.exchangerate.host/${date}?base=USD&symbols=PLN,GBP,EUR`);
      const data = await res.json();
      fx = data.rates;
      render();
    }

    async function fetchAll() {
      const [a, p] = await Promise.all([
        supabase.from('stock').select('*'),
        supabase.from('pl_stock').select('*')
      ]);
      admin = a.data || [];
      pl = p.data || [];
      populateCats();
      await loadFx();
    }

    function populateCats() {
      const cats = [...new Set(admin.map(x=>x.category))];
      const sel = document.getElementById('catFilter');
      sel.innerHTML = '<option value="">All Categories</option>' +
        cats.map(c=>`<option>${c}</option>`).join('');
    }

    function render() {
      const term = document.getElementById('search').value.toLowerCase();
      const cat = document.getElementById('catFilter').value;
      const tbody = document.querySelector('#report tbody');
      tbody.innerHTML = '';
      let sums = { USD:0, PLN:0, GBP:0, EUR:0 }, byCat={};

      admin.forEach(a=>{
        if (!a.name.toLowerCase().includes(term)) return;
        if (cat && a.category!==cat) return;
        const p = pl.find(x=>x.name===a.name) || {qty:0};
        const total = a.qty + p.qty;
        const costUsd = a.cost_usd || 0;
        const sellPln = a.sell_pln || 0;
        const rowFx = {
          USD: costUsd,
          PLN: costUsd * fx.PLN,
          GBP: costUsd * fx.GBP,
          EUR: costUsd * fx.EUR
        };
        const sellFx = {
          PLN: sellPln,
          USD: sellPln / fx.PLN,
          GBP: sellPln / fx.PLN * fx.GBP,
          EUR: sellPln / fx.PLN * fx.EUR
        };
        const valUsd = total * sellFx.USD;
        const valPln = total * sellFx.PLN;
        const valGbp = total * sellFx.GBP;
        const valEur = total * sellFx.EUR;

        // accumulate totals
        sums.USD += valUsd; sums.PLN += valPln;
        sums.GBP += valGbp; sums.EUR += valEur;
        byCat[a.category] = (byCat[a.category]||0) + valPln;

        const isLow = total <= 50 ? 'low-stock' : '';
        tbody.innerHTML += `
          <tr class="${isLow}">
            <td>${a.name}</td>
            <td>${a.category}</td>
            <td>${a.qty}</td>
            <td>${p.qty||'—'}</td>
            <td>${total}</td>
            <td>$${rowFx.USD.toFixed(2)}</td>
            <td>${rowFx.PLN.toFixed(2)}</td>
            <td>£${rowFx.GBP.toFixed(2)}</td>
            <td>€${rowFx.EUR.toFixed(2)}</td>
            <td>${sellFx.PLN.toFixed(2)}</td>
            <td>$${sellFx.USD.toFixed(2)}</td>
            <td>£${sellFx.GBP.toFixed(2)}</td>
            <td>€${sellFx.EUR.toFixed(2)}</td>
            <td>$${valUsd.toFixed(2)}</td>
            <td>${valPln.toFixed(2)}</td>
            <td>£${valGbp.toFixed(2)}</td>
            <td>€${valEur.toFixed(2)}</td>
          </tr>`;
      });

      // footer totals
      document.getElementById('totUsd').textContent = `$${sums.USD.toFixed(2)}`;
      document.getElementById('totPln').textContent = `${sums.PLN.toFixed(2)} PLN`;
      document.getElementById('totGbp').textContent = `£${sums.GBP.toFixed(2)}`;
      document.getElementById('totEur').textContent = `€${sums.EUR.toFixed(2)}`;

      renderChart(byCat);
    }

    let chart;
    function renderChart(data) {
      const ctx = document.getElementById('chart').getContext('2d');
      const labels = Object.keys(data), values = Object.values(data);
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels, datasets:[{
            label:'Value by Category (PLN)',
            data:values,
            backgroundColor:'#7ee2f6'
          }]
        },
        options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }

    window.addEventListener('DOMContentLoaded', fetchAll);
  </script>
</body>
</html>
