<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Inventory Valuation & Multi-Currency Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { margin:0; font-family:Inter,sans-serif; background:#0b1c2c; color:#fff }
    .container { max-width:1200px; margin:0 auto; padding:2rem }
    .back-btn { background:#1e3d5e; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; display:inline-block; margin-bottom:1rem }
    .back-btn:hover { background:#285a87 }
    h1 { margin-top:0 }
    .filters { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem }
    .filters input, .filters select, .filters button { font-size:1rem; padding:8px; border:0; border-radius:6px }
    .filters input, .filters select, .filters button { background:#fff; color:#000 }
    .filters button { cursor:pointer }
    table { width:100%; border-collapse:collapse; background:#15273a; border-radius:8px; overflow:hidden }
    th, td { padding:8px 12px; border-bottom:1px solid #1e3d5e; font-size:.9rem }
    th { background:#112b44; text-align:left }
    .numeric { text-align:right }
    tfoot td { background:#112b44; font-weight:bold }
    tr.low-stock { background:rgba(255,0,0,0.1) }
    canvas { margin-top:2rem; background:#fff; border-radius:8px; padding:1rem }
  </style>
</head>
<body>
  <div class="container">
    <a href="dashboard-admin.html" class="back-btn">⬅ Back to Dashboard</a>
    <h1>Inventory Valuation &amp; Multi-Currency Report</h1>

    <div class="filters">
      <button id="btnLoadFx">Load FX Rates</button>
      <input type="text" id="searchInput" placeholder="Search product…" oninput="render()"/>
      <select id="categoryFilter" onchange="render()">
        <option value="">All Categories</option>
      </select>
    </div>

    <table id="reportTable">
      <thead>
        <tr>
          <th>Product</th><th>Category</th>
          <th class="numeric">Qty (Admin)</th><th class="numeric">Qty (PL)</th><th class="numeric">Total Qty</th>
          <th class="numeric">Cost USD</th><th class="numeric">Cost PLN</th><th class="numeric">Cost GBP</th><th class="numeric">Cost EUR</th>
          <th class="numeric">Sell PLN</th><th class="numeric">Sell GBP</th><th class="numeric">Sell EUR</th>
          <th class="numeric">Value PLN</th><th class="numeric">Value GBP</th><th class="numeric">Value EUR</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="9">Totals:</td>
          <td id="tSellPln" class="numeric">0.00 PLN</td>
          <td id="tSellGbp" class="numeric">£0.00</td>
          <td id="tSellEur" class="numeric">€0.00</td>
          <td id="tValPln"  class="numeric">0.00 PLN</td>
          <td id="tValGbp"  class="numeric">£0.00</td>
          <td id="tValEur"  class="numeric">€0.00</td>
        </tr>
      </tfoot>
    </table>

    <canvas id="categoryChart" height="80"></canvas>
  </div>

  <script>
    // Initialize Supabase with your full URL & anon key
    const supabase = window.supabase.createClient(
      'https://rwmwsaxlqblvnhfyuuqg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
    );

    let adminStock = [], plStock = [];
    let fx = { PLN:1, GBP:1, EUR:1 };

    document.getElementById('btnLoadFx').onclick = loadFx;
    window.addEventListener('DOMContentLoaded', async () => {
      // Load data from Supabase
      const [a,p] = await Promise.all([
        supabase.from('stock').select('*'),
        supabase.from('pl_stock').select('*')
      ]);
      adminStock = a.data||[];
      plStock    = p.data||[];
      populateCategories();
      await loadFx();
    });

    // Fetch live FX from ExchangeRate-API
    async function loadFx() {
      const url = 'https://open.er-api.com/v6/latest/USD';
      const res = await fetch(url);
      const json = await res.json();
      console.log('FX API response:', json);
      if (json.result === 'success' && json.rates) {
        fx = {
          PLN: json.rates.PLN,
          GBP: json.rates.GBP,
          EUR: json.rates.EUR
        };
        console.log('✔️ FX loaded:', fx);
      } else {
        console.warn('⚠️ FX lookup failed; using 1:1');
        fx = { PLN:1, GBP:1, EUR:1 };
      }
      render();
    }

    function populateCategories() {
      const sel = document.getElementById('categoryFilter');
      sel.innerHTML = `<option value="">All Categories</option>`
        + [...new Set(adminStock.map(r=>r.category))]
            .map(c=>`<option>${c}</option>`).join('');
    }

    function render() {
      const term = searchInput.value.toLowerCase();
      const catF = categoryFilter.value;
      const tbody = reportTable.tBodies[0];
      tbody.innerHTML = '';
      let totals = {sellPln:0,sellGbp:0,sellEur:0,valPln:0,valGbp:0,valEur:0};

      adminStock.forEach(r=>{
        if (!r.name.toLowerCase().includes(term) ||
            (catF && r.category!==catF)) return;

        const pl = plStock.find(x=>x.name===r.name)||{};
        const qtyA=Number(r.qty)||0, qtyP=Number(pl.qty)||0, totalQty=qtyA+qtyP;
        const costUsd=Number(r.cost_usd)||0;
        const costPln=costUsd*fx.PLN, costGbp=costUsd*fx.GBP, costEur=costUsd*fx.EUR;
        const sellPln=Number(r.sell_pln)||0, sellUsd=sellPln/fx.PLN,
              sellGbp=sellUsd*fx.GBP, sellEur=sellUsd*fx.EUR;
        const valPln=totalQty*sellPln, valGbp=totalQty*sellGbp, valEur=totalQty*sellEur;

        totals.sellPln+=sellPln; totals.sellGbp+=sellGbp; totals.sellEur+=sellEur;
        totals.valPln+=valPln;   totals.valGbp+=valGbp;   totals.valEur+=valEur;

        const tr=document.createElement('tr');
        if (totalQty<=50) tr.classList.add('low-stock');
        tr.innerHTML=`
          <td>${r.name}</td>
          <td>${r.category}</td>
          <td class="numeric">${qtyA}</td>
          <td class="numeric">${qtyP}</td>
          <td class="numeric">${totalQty}</td>
          <td class="numeric">${new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(costUsd)}</td>
          <td class="numeric">${new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(costPln)}</td>
          <td class="numeric">${new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(costGbp)}</td>
          <td class="numeric">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(costEur)}</td>
          <td class="numeric">${new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(sellPln)}</td>
          <td class="numeric">${new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(sellGbp)}</td>
          <td class="numeric">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(sellEur)}</td>
          <td class="numeric">${new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(valPln)}</td>
          <td class="numeric">${new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(valGbp)}</td>
          <td class="numeric">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(valEur)}</td>
        `;
        tbody.appendChild(tr);
      });

      tSellPln.textContent=new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(totals.sellPln);
      tSellGbp.textContent=new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(totals.sellGbp);
      tSellEur.textContent=new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(totals.sellEur);
      tValPln.textContent=new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(totals.valPln);
      tValGbp.textContent=new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(totals.valGbp);
      tValEur.textContent=new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(totals.valEur);

      // Chart
      const sums={};
      document.querySelectorAll('#reportTable tbody tr').forEach(tr=>{
        const c=tr.cells[1].textContent;
        const v=parseFloat(tr.cells[12].textContent.replace(/[^0-9.-]/g,''))||0;
        sums[c]=(sums[c]||0)+v;
      });
      const ctx=categoryChart.getContext('2d');
      if(window.myChart) window.myChart.destroy();
      window.myChart=new Chart(ctx,{type:'bar',
        data:{labels:Object.keys(sums),datasets:[{label:'Value by Category (PLN)',data:Object.values(sums)}]},
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
      });
    }
  </script>
</body>
</html>
