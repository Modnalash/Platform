<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Valuation & Multi-Currency Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { margin: 0; font-family: 'Inter', sans-serif; background: #0b1c2c; color: #fff; }
    .container { max-width: 1200px; margin: auto; padding: 2rem; }
    .back-btn { display: inline-block; margin-bottom: 1rem; background: #1e3d5e; color: #fff; padding: 8px 12px; border-radius: 6px; text-decoration: none; }
    .back-btn:hover { background: #285a87; }
    h1 { margin-top: 0; }
    .filters { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .filters input, .filters select, .filters button { font-size: 1rem; padding: 8px; border: none; border-radius: 6px; }
    .filters input, .filters select { background: #fff; color: #000; }
    .filters button { background: #fff; color: #000; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; background: #15273a; border-radius: 8px; overflow: hidden; margin-top: 1rem; }
    th, td { padding: 8px 12px; border-bottom: 1px solid #1e3d5e; font-size: .9rem; }
    th { background: #112b44; text-align: left; }
    .numeric { text-align: right; }
    tfoot td { background: #112b44; font-weight: bold; }
    tr.low-stock { background: rgba(255,0,0,0.1); }
    canvas { margin-top: 2rem; background: #fff; border-radius: 8px; padding: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <a href="dashboard-admin.html" class="back-btn">⬅ Back to Dashboard</a>
    <h1>Inventory Valuation &amp; Multi-Currency Report</h1>

    <div class="filters">
      <label>FX Date:
        <input type="date" id="fxDate" max="" />
      </label>
      <button id="btnLoadFx">Load FX Rates</button>
      <input type="text" id="searchInput" placeholder="Search product…" oninput="render()" />
      <select id="categoryFilter" onchange="render()">
        <option value="">All Categories</option>
      </select>
    </div>

    <table id="reportTable">
      <thead>
        <tr>
          <th>Product</th><th>Category</th>
          <th class="numeric">Qty (Admin)</th><th class="numeric">Qty (PL)</th><th class="numeric">Total Qty</th>
          <th class="numeric">Cost USD</th><th class="numeric">Cost PLN</th><th class="numeric">Cost GBP</th><th class="numeric">Cost EUR</th>
          <th class="numeric">Sell PLN</th><th class="numeric">Sell GBP</th><th class="numeric">Sell EUR</th>
          <th class="numeric">Value PLN</th><th class="numeric">Value GBP</th><th class="numeric">Value EUR</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="9">Totals:</td>
          <td id="tSellPln" class="numeric">0.00 PLN</td>
          <td id="tSellGbp" class="numeric">£0.00</td>
          <td id="tSellEur" class="numeric">€0.00</td>
          <td id="tValPln"  class="numeric">0.00 PLN</td>
          <td id="tValGbp"  class="numeric">£0.00</td>
          <td id="tValEur"  class="numeric">€0.00</td>
        </tr>
      </tfoot>
    </table>

    <canvas id="categoryChart" height="80"></canvas>
  </div>

  <script>
    // --- Supabase setup ---
    const supabase = window.supabase.createClient(
      'https://rwmwsaxlqblvnhfyuuqg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
    );
    let adminStock = [], plStock = [];
    let fx = { PLN:1, GBP:1, EUR:1 }; // default fallback

    // --- FX Date setup ---
    const fxDate = document.getElementById('fxDate');
    const today = new Date().toISOString().slice(0,10);
    fxDate.max = today;
    fxDate.value = today;
    document.getElementById('btnLoadFx').addEventListener('click', loadFx);
    window.addEventListener('DOMContentLoaded', init);

    async function init() {
      // Load stock data
      const [a, p] = await Promise.all([
        supabase.from('stock').select('*'),
        supabase.from('pl_stock').select('*')
      ]);
      adminStock = a.data || [];
      plStock    = p.data || [];
      populateCategories();
      await loadFx();
    }

    async function loadFx() {
      const date = fxDate.value;
      // If user selects past date (before today), try historical, else latest
      if (date < today) {
        const histUrl = `https://api.exchangerate.host/historical?date=${date}&base=USD&symbols=PLN,GBP,EUR`;
        try {
          const res = await fetch(histUrl);
          const json = await res.json();
          console.log('Historical FX response:', json);
          if (json.rates && typeof json.rates.PLN === 'number') {
            fx = { ...json.rates };
            console.log('✔️ Loaded historical rates:', fx);
            render();
            return;
          }
          console.warn('❗ No historical rates found for', date);
        } catch (e) {
          console.error('❗ Error fetching historical FX:', e);
        }
      }

      // Fallback to latest
      const latestUrl = `https://api.exchangerate.host/latest?base=USD&symbols=PLN,GBP,EUR`;
      try {
        const res2 = await fetch(latestUrl);
        const json2 = await res2.json();
        console.log('Latest FX response:', json2);
        if (json2.rates && typeof json2.rates.PLN === 'number') {
          fx = { ...json2.rates };
          console.log('✔️ Loaded latest rates:', fx);
        } else {
          console.warn('⚠️ No latest rates, using fallback 1:1');
        }
      } catch (e) {
        console.error('❗ Error fetching latest FX:', e);
      }

      render();
    }

    function populateCategories() {
      const sel = document.getElementById('categoryFilter');
      sel.innerHTML = `<option value="">All Categories</option>` +
                      [...new Set(adminStock.map(r => r.category))]
                        .map(c => `<option>${c}</option>`)
                        .join('');
    }

    function render() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      const catF = document.getElementById('categoryFilter').value;
      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = '';

      const totals = { sellPln:0, sellGbp:0, sellEur:0, valPln:0, valGbp:0, valEur:0 };

      adminStock.forEach(r => {
        if (!r.name.toLowerCase().includes(term)) return;
        if (catF && r.category !== catF) return;

        const pl = plStock.find(x => x.name === r.name) || {};
        const qtyA = Number(r.qty) || 0;
        const qtyP = Number(pl.qty) || 0;
        const totalQty = qtyA + qtyP;

        // cost USD → convert
        const costUsd = Number(r.cost_usd) || 0;
        const costPln = costUsd * fx.PLN;
        const costGbp = costUsd * fx.GBP;
        const costEur = costUsd * fx.EUR;

        // sell stored in PLN → USD → convert
        const sellPln = Number(r.sell_pln) || 0;
        const sellUsd = sellPln / fx.PLN;
        const sellGbp = sellUsd * fx.GBP;
        const sellEur = sellUsd * fx.EUR;

        const valPln = totalQty * sellPln;
        const valGbp = totalQty * sellGbp;
        const valEur = totalQty * sellEur;

        totals.sellPln += sellPln;
        totals.sellGbp += sellGbp;
        totals.sellEur += sellEur;
        totals.valPln  += valPln;
        totals.valGbp  += valGbp;
        totals.valEur  += valEur;

        const tr = document.createElement('tr');
        if (totalQty <= 50) tr.classList.add('low-stock');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.category}</td>
          <td class="numeric">${qtyA}</td>
          <td class="numeric">${qtyP}</td>
          <td class="numeric">${totalQty}</td>
          <td class="numeric">${new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(costUsd)}</td>
          <td class="numeric">${new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(costPln)}</td>
          <td class="numeric">${new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(costGbp)}</td>
          <td class="numeric">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(costEur)}</td>
          <td class="numeric">${new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(sellPln)}</td>
          <td class="numeric">${new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(sellGbp)}</td>
          <td class="numeric">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(sellEur)}</td>
          <td class="numeric">${new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(valPln)}</td>
          <td class="numeric">${new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(valGbp)}</td>
          <td class="numeric">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(valEur)}</td>
        `;
        tbody.appendChild(tr);
      });

      // update footer
      document.getElementById('tSellPln').textContent = new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(totals.sellPln);
      document.getElementById('tSellGbp').textContent = new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(totals.sellGbp);
      document.getElementById('tSellEur').textContent = new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(totals.sellEur);
      document.getElementById('tValPln').textContent  = new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(totals.valPln);
      document.getElementById('tValGbp').textContent  = new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(totals.valGbp);
      document.getElementById('tValEur').textContent  = new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(totals.valEur);

      drawChart();
    }

    function drawChart() {
      const sums = {};
      document.querySelectorAll('#reportTable tbody tr').forEach(tr => {
        const cat = tr.cells[1].textContent;
        const val = parseFloat(tr.cells[12].textContent.replace(/[^0-9\.-]/g,'')) || 0;
        sums[cat] = (sums[cat] || 0) + val;
      });
      const ctx = document.getElementById('categoryChart').getContext('2d');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: Object.keys(sums), datasets: [{ label: 'Value by Category (PLN)', data: Object.values(sums) }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }
  </script>
</body>
</html>
