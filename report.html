<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Inventory Valuation & Multi-Currency Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { margin:0; font-family:'Inter',sans-serif; background:#0b1c2c; color:#fff }
    .container { max-width:1200px; margin:auto; padding:2rem }
    .back-btn {
      display:inline-block; margin-bottom:1rem;
      background:#1e3d5e; color:#fff; padding:8px 12px;
      border-radius:6px; text-decoration:none;
    }
    .back-btn:hover { background:#285a87 }
    h1 { margin-top:0; }
    .filters {
      display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem;
    }
    .filters label,
    .filters input,
    .filters select,
    .filters button {
      font-size:1rem;
    }
    .filters input[type=date],
    .filters input[type=text],
    .filters select,
    .filters button {
      padding:8px; border:none; border-radius:6px;
      background:#fff; color:#000;
    }
    .filters button { cursor:pointer; }
    table {
      width:100%; border-collapse:collapse; background:#15273a;
      border-radius:8px; overflow:hidden; margin-top:1rem;
    }
    th, td {
      padding:8px 12px; border-bottom:1px solid #1e3d5e;
      font-size:.9rem; vertical-align:middle;
    }
    th { background:#112b44; text-align:left }
    .numeric { text-align:right; }
    tfoot td { background:#112b44; font-weight:bold }
    tr.low-stock { background:rgba(255,0,0,0.1) }
    canvas { margin-top:2rem; background:#fff; border-radius:8px; padding:1rem }
  </style>
</head>
<body>
  <div class="container">
    <a href="dashboard-admin.html" class="back-btn">⬅ Back to Dashboard</a>
    <h1>Inventory Valuation &amp; Multi-Currency Report</h1>

    <div class="filters">
      <label>FX Date:
        <input type="date" id="fxDate" max="">
      </label>
      <button onclick="loadFx()">Load FX Rates</button>
      <input type="text" id="searchInput" placeholder="Search product…" oninput="render()">
      <select id="categoryFilter" onchange="render()">
        <option value="">All Categories</option>
      </select>
    </div>

    <table id="reportTable">
      <thead>
        <tr>
          <th>Product</th>
          <th>Category</th>
          <th class="numeric">Qty (Admin)</th>
          <th class="numeric">Qty (PL)</th>
          <th class="numeric">Total Qty</th>
          <th class="numeric">Cost USD</th>
          <th class="numeric">Cost PLN</th>
          <th class="numeric">Cost GBP</th>
          <th class="numeric">Cost EUR</th>
          <th class="numeric">Sell PLN</th>
          <th class="numeric">Sell GBP</th>
          <th class="numeric">Sell EUR</th>
          <th class="numeric">Value PLN</th>
          <th class="numeric">Value GBP</th>
          <th class="numeric">Value EUR</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="9">Totals:</td>
          <td id="tSellPln" class="numeric">0.00 PLN</td>
          <td id="tSellGbp" class="numeric">£0.00</td>
          <td id="tSellEur" class="numeric">€0.00</td>
          <td id="tValPln" class="numeric">0.00 PLN</td>
          <td id="tValGbp" class="numeric">£0.00</td>
          <td id="tValEur" class="numeric">€0.00</td>
        </tr>
      </tfoot>
    </table>

    <canvas id="categoryChart" height="80"></canvas>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://rwmwsaxlqblvnhfyuuqg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
    );

    let adminStock = [], plStock = [], fx = { PLN:1, GBP:1, EUR:1 };

    // setup date input
    const fxDate = document.getElementById('fxDate');
    fxDate.max = new Date().toISOString().slice(0,10);
    fxDate.value = fxDate.max;

    window.addEventListener('DOMContentLoaded', init);

    async function init(){
      // fetch admin stock
      const a = await supabase.from('stock').select('*');
      adminStock = Array.isArray(a.data) ? a.data : [];

      // try fetch pl_stock, but on error just use []
      try {
        const p = await supabase.from('pl_stock').select('*');
        plStock = Array.isArray(p.data) ? p.data : [];
      } catch {
        plStock = [];
      }

      populateCategories();
      await loadFx();
      render();
    }

    async function loadFx(){
      const date = fxDate.value;
      let data;
      try {
        const res = await fetch(`https://api.exchangerate.host/${date}?base=USD&symbols=PLN,GBP,EUR`);
        data = await res.json();
        if(!data.rates) throw 0;
      } catch {
        const res2 = await fetch(`https://api.exchangerate.host/latest?base=USD&symbols=PLN,GBP,EUR`);
        data = await res2.json();
      }
      fx = data.rates;
      console.log('FX:', fx);
      render();
    }

    function populateCategories(){
      const cats = [...new Set(adminStock.map(r=>r.category))];
      const sel = document.getElementById('categoryFilter');
      sel.innerHTML = `<option value="">All Categories</option>` + 
        cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    function render(){
      const term = document.getElementById('searchInput').value.toLowerCase();
      const catFilter = document.getElementById('categoryFilter').value;
      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = '';

      const totals = {sellPln:0,sellGbp:0,sellEur:0,valPln:0,valGbp:0,valEur:0};

      adminStock.forEach(r=>{
        if(!r.name.toLowerCase().includes(term)) return;
        if(catFilter && r.category!==catFilter) return;

        const pl = plStock.find(p=>p.name===r.name);
        const qA = +r.qty||0, qP = +pl?.qty||0, tQ = qA+qP;
        const cUsd = +r.cost_usd||0;
        const cPln = cUsd*fx.PLN, cGbp = cUsd*fx.GBP, cEur = cUsd*fx.EUR;
        const sPln = +r.sell_pln||0;
        const sUsd = sPln/fx.PLN, sGbp = sUsd*fx.GBP, sEur = sUsd*fx.EUR;
        const vPln = tQ*sPln, vGbp = tQ*sGbp, vEur = tQ*sEur;

        totals.sellPln += sPln*tQ;
        totals.sellGbp += sGbp*tQ;
        totals.sellEur += sEur*tQ;
        totals.valPln  += vPln;
        totals.valGbp  += vGbp;
        totals.valEur  += vEur;

        const tr = document.createElement('tr');
        if(tQ<=50) tr.classList.add('low-stock');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.category}</td>
          <td class="numeric">${qA}</td>
          <td class="numeric">${qP}</td>
          <td class="numeric">${tQ}</td>
          <td class="numeric">${new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(cUsd)}</td>
          <td class="numeric">${new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(cPln)}</td>
          <td class="numeric">${new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(cGbp)}</td>
          <td class="numeric">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(cEur)}</td>
          <td class="numeric">${new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(sPln)}</td>
          <td class="numeric">${new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(sGbp)}</td>
          <td class="numeric">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(sEur)}</td>
          <td class="numeric">${new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(vPln)}</td>
          <td class="numeric">${new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(vGbp)}</td>
          <td class="numeric">${new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(vEur)}</td>
        `;
        tbody.appendChild(tr);
      });

      // update footer
      document.getElementById('tSellPln').textContent = 
        new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(totals.sellPln);
      document.getElementById('tSellGbp').textContent = 
        new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(totals.sellGbp);
      document.getElementById('tSellEur').textContent = 
        new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(totals.sellEur);
      document.getElementById('tValPln').textContent  = 
        new Intl.NumberFormat('pl-PL',{style:'currency',currency:'PLN'}).format(totals.valPln);
      document.getElementById('tValGbp').textContent  = 
        new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(totals.valGbp);
      document.getElementById('tValEur').textContent  = 
        new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(totals.valEur);

      drawChart();
    }

    function drawChart(){
      const sums={};
      document.querySelectorAll('#reportTable tbody tr').forEach(tr=>{
        const cat=tr.cells[1].textContent;
        const raw=tr.cells[13].textContent;
        const num=parseFloat(raw.replace(/[^\d.-]/g,''))||0;
        sums[cat]=(sums[cat]||0)+num;
      });
      const ctx=document.getElementById('categoryChart').getContext('2d');
      if(window.myChart) window.myChart.destroy();
      window.myChart=new Chart(ctx,{
        type:'bar',
        data:{
          labels:Object.keys(sums),
          datasets:[{label:'Value by Category (PLN)',data:Object.values(sums),backgroundColor:'#7ee2f6'}]
        },
        options:{responsive:true,scales:{y:{beginAtZero:true}}}
      });
    }
  </script>
</body>
</html>
