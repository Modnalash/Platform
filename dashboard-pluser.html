<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PL Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <h1>PL Dashboard</h1>

    <div>
      <label for="categoryFilter">Filter by Category:</label>
      <select id="categoryFilter" onchange="filterStock()">
        <option value="All">All</option>
        <option value="Lashes">Lashes</option>
        <option value="Accessories">Accessories</option>
        <option value="Make-up">Make-up</option>
      </select>
    </div>

    <table id="stockTable">
      <thead>
        <tr>
          <th>Product</th>
          <th>Category</th>
          <th>Available</th>
          <th>Order Qty</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="submitOrder()">Submit Order</button>

    <div id="summaryModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h3>Order Summary</h3>
        <ul id="orderSummary"></ul>
        <button onclick="confirmOrder()">Confirm</button>
        <button onclick="document.getElementById('summaryModal').style.display='none'">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = 'https://rwmwsaxlqblvnhfyuuqg.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y';
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    async function loadStock() {
      const { data, error } = await supabaseClient
        .from('stock')
        .select('*')
        .eq('region', 'PL');

      if (error) {
        console.error('Error loading stock:', error);
        return;
      }

      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = '';
      data.forEach(item => {
        const row = document.createElement('tr');
        row.setAttribute('data-category', item.category);
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>${item.qty}</td>
          <td><input type="number" min="0" max="${item.qty}" data-product="${item.name}" /></td>
        `;
        tbody.appendChild(row);
      });
    }

    function filterStock() {
      const category = document.getElementById('categoryFilter').value;
      document.querySelectorAll('#stockTable tbody tr').forEach(row => {
        row.style.display = category === 'All' || row.getAttribute('data-category') === category ? '' : 'none';
      });
    }

    function submitOrder() {
      const rows = document.querySelectorAll('#stockTable tbody tr');
      const summary = document.getElementById('orderSummary');
      summary.innerHTML = '';
      rows.forEach(row => {
        const input = row.querySelector('input');
        const qty = parseInt(input.value);
        if (qty > 0) {
          const product = input.getAttribute('data-product');
          const li = document.createElement('li');
          li.textContent = `${product}: ${qty}`;
          summary.appendChild(li);
        }
      });
      document.getElementById('summaryModal').style.display = 'block';
    }

    async function confirmOrder() {
      const rows = document.querySelectorAll('#stockTable tbody tr');
      for (const row of rows) {
        const input = row.querySelector('input');
        const qty = parseInt(input.value);
        if (qty > 0) {
          const product = input.getAttribute('data-product');
          await supabaseClient.from('orders').insert([
            {
              user_email: 'pluser@modna.com',
              region: 'PL',
              product,
              qty,
              status: 'Pending',
            },
          ]);
        }
      }
      document.getElementById('summaryModal').style.display = 'none';
      alert('Order submitted!');
      loadStock();
    }

    loadStock();
  </script>
</body>
</html>
