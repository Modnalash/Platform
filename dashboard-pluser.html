<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PL Dashboard</title>

  <!-- Supabase (load ONCE) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #0d1b2a; color: #fff; margin: 0; padding: 0; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: #112d4e; }
    header h1 { margin: 0; font-size: 2.2rem; font-weight: 700; }
    .logout-btn { background: #f44336; border: none; color: white; padding: 10px 18px; cursor: pointer; border-radius: 6px; font-size: 1rem; }
    .container { padding: 20px; }

    .top-actions { display: flex; gap: 12px; margin: 16px 0 26px 0; flex-wrap: wrap; }
    .top-btn { background: #00a8e8; border: none; color: white; padding: 10px 16px; cursor: pointer; border-radius: 6px; font-size: 1rem; }
    .top-btn:hover { opacity: 0.95; }

    h2 { margin-top: 0; font-size: 2rem; }

    .filter-row { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 18px; align-items: center; }
    .filter-row label { margin-right: 6px; font-weight: 600; }
    .filter-row input, .filter-row select { padding: 8px 12px; border-radius: 6px; border: none; font-size: 1rem; }

    table { width: 100%; border-collapse: collapse; background-color: #1b263b; margin-bottom: 20px; }
    th, td { padding: 10px; border: 1px solid #2b3a50; text-align: left; }
    th { background-color: #112d4e; }

    .order-btn, .submit-btn {
      background: #3fbc5f;
      padding: 10px 16px;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    .order-btn:hover, .submit-btn:hover { background: #2c9e4c; }

    #orderPreview { margin: 0; padding-left: 18px; }
    .muted { opacity: .9; }
  </style>
</head>

<body>
  <header>
    <h1>Hello Olivia</h1>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <div class="container">
    <div class="top-actions">
      <button class="top-btn" onclick="location.href='manage-pl-stock.html'">ðŸ”§ Manage Local Stock</button>
      <button class="top-btn" onclick="location.href='order-history-pl.html'">ðŸ“œ Order History</button>
    </div>

    <h2>Place an Order</h2>

    <div class="filter-row">
      <label for="searchInput">Search Product:</label>
      <input type="text" id="searchInput" placeholder="Search by product or SKU..." oninput="applyFilter()" />

      <label for="categoryFilter">Filter by Category:</label>
      <select id="categoryFilter" onchange="applyFilter()">
        <option value="All">All</option>
      </select>
    </div>

    <table id="stockTable">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Product</th>
          <th>Category</th>
          <th>Available</th>
          <th>Qty</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div>
      <h3>ðŸ›’ Order Summary</h3>
      <ul id="orderPreview" class="muted"></ul>
      <button class="submit-btn" onclick="submitOrder()">âœ… Confirm and Submit Order</button>
    </div>
  </div>

  <script>
    // IMPORTANT FIX: do NOT use "const supabase = ..." to avoid redeclare.
    const sb = window.supabase.createClient(
      'https://rwmwsaxlqblvnhfyuuqg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
    );

    let currentUser = null;
    let stockRows = [];
    let orderItems = [];

    async function logAction(action, details) {
      if (!currentUser) return;
      await sb.from('audit_log').insert([{
        user_id: currentUser.id,
        user_email: currentUser.email,
        action,
        details
      }]);
    }

    async function boot() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) { window.location.href = "index.html"; return; }
      currentUser = user;

      const { data: profile, error: pErr } = await sb
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();

      if (pErr || !profile || profile.role !== 'pl') {
        window.location.href = "index.html";
        return;
      }

      await logAction("Login", { page: "dashboard-pluser" });

      await fetchStock();
      populateCategoryDropdown();
      renderTable();
      applyFilter();
    }

    async function fetchStock() {
      const { data, error } = await sb
        .from('stock')
        .select('id, sku, name, category, qty')
        .order('name', { ascending: true });

      if (error) {
        alert("Stock load error: " + error.message);
        console.error(error);
        stockRows = [];
        return;
      }

      stockRows = data || [];
    }

    function populateCategoryDropdown() {
      const sel = document.getElementById('categoryFilter');
      const cats = Array.from(new Set(stockRows.map(r => r.category).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b));

      sel.innerHTML = `<option value="All">All</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function renderTable() {
      const tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = '';

      for (const item of stockRows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.sku || ''}</td>
          <td>${item.name || ''}</td>
          <td>${item.category || ''}</td>
          <td>${item.qty ?? 0}</td>
          <td>
            <input type="number"
              min="0"
              max="${item.qty ?? 0}"
              value="0"
              data-id="${item.id}"
              data-sku="${item.sku || ''}"
              data-name="${item.name || ''}"
              data-cat="${item.category || ''}"
              data-available="${item.qty ?? 0}"
              style="width:90px;padding:6px 8px;border-radius:6px;border:none;"
            />
          </td>
          <td>
            <button class="order-btn" onclick="addToOrder(this)">Add</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function applyFilter() {
      const search = document.getElementById('searchInput').value.trim().toLowerCase();
      const cat = document.getElementById('categoryFilter').value;

      document.querySelectorAll('#stockTable tbody tr').forEach(row => {
        const sku = row.cells[0].innerText.toLowerCase();
        const name = row.cells[1].innerText.toLowerCase();
        const rowCat = row.cells[2].innerText;

        const okSearch = !search || sku.includes(search) || name.includes(search);
        const okCat = (cat === 'All' || rowCat === cat);

        row.style.display = (okSearch && okCat) ? '' : 'none';
      });
    }

    function addToOrder(btn) {
      const input = btn.closest('tr').querySelector('input');
      const qty = parseInt(input.value, 10);
      const available = parseInt(input.dataset.available, 10);

      if (!qty || qty <= 0) return;
      if (qty > available) return alert("Qty is higher than available stock.");

      orderItems.push({
        stock_id: input.dataset.id,
        sku: input.dataset.sku || null,
        product: input.dataset.name,
        category: input.dataset.cat,
        qty,
        available
      });

      input.value = 0;
      updateOrderPreview();
    }

    function updateOrderPreview() {
      const ul = document.getElementById('orderPreview');
      ul.innerHTML = '';
      orderItems.forEach(i => {
        ul.insertAdjacentHTML(
          'beforeend',
          `<li>${i.sku ? i.sku + " â€” " : ""}${i.product} (${i.category}) x ${i.qty}</li>`
        );
      });
    }

    async function submitOrder() {
      if (!orderItems.length) return alert("âŒ No items in order.");

      const groupId = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));

      await logAction("Place Order", { groupId, items: orderItems });

      for (const item of orderItems) {
        const { error: insErr } = await sb.from('orders').insert([{
          region: 'PL',
          sku: item.sku,
          product: item.product,
          category: item.category,
          qty: item.qty,
          order_group_id: groupId,
          status: 'Pending'
        }]);

        if (insErr) {
          alert("âŒ Order insert failed: " + insErr.message);
          console.error(insErr);
          return;
        }

        const { error: upErr } = await sb
          .from('stock')
          .update({ qty: item.available - item.qty })
          .eq('id', item.stock_id);

        if (upErr) {
          alert("âŒ Stock update failed: " + upErr.message);
          console.error(upErr);
          return;
        }
      }

      alert("âœ… Order placed successfully!");
      orderItems = [];
      updateOrderPreview();

      await fetchStock();
      populateCategoryDropdown();
      renderTable();
      applyFilter();
    }

    async function logout() {
      await logAction("Logout", { page: "dashboard-pluser" });
      await sb.auth.signOut();
      localStorage.clear();
      sessionStorage.clear();
      setTimeout(() => window.location.href = "index.html", 200);
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
