<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Valuation Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { margin: 0; font-family: 'Inter', sans-serif; background-color: #0b1c2c; color: #fff; }
    .container { padding: 2rem; max-width: 1200px; margin: auto; }
    h1 { text-align: center; margin-bottom: 2rem; }
    .filters { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; }
    .filters input, .filters select { padding: 8px; font-size: 1rem; border-radius: 6px; border: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; background-color: #15273a; border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #1e3d5e; }
    th { background-color: #112b44; }
    tfoot td { font-weight: bold; background-color: #112b44; }
    canvas { margin-top: 2rem; background: #fff; border-radius: 12px; padding: 1rem; }
    .back-btn {
      display: inline-block;
      margin-bottom: 1rem;
      background-color: #1e3d5e;
      color: #fff;
      padding: 10px 16px;
      border-radius: 6px;
      text-decoration: none;
      transition: background 0.3s;
    }
    .back-btn:hover { background-color: #285a87; }
  </style>
</head>
<body>
  <div class="container">
    <a href="dashboard-admin.html" class="back-btn">â¬… Back to Dashboard</a>
    <h1>Inventory Valuation Report</h1>
    <div class="filters">
      <input type="text" id="searchInput" placeholder="Search by product name..." oninput="renderTable()">
      <select id="categoryFilter" onchange="renderTable()">
        <option value="">All Categories</option>
      </select>
    </div>

    <table id="reportTable">
      <thead>
        <tr>
          <th>Product</th>
          <th>Category</th>
          <th>Qty (Admin)</th>
          <th>Qty (PL)</th>
          <th>Total Qty</th>
          <th>Cost USD</th>
          <th>Value USD</th>
          <th>Sell PLN</th>
          <th>Value PLN</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="6">Total</td>
          <td id="totalUsd">$0.00</td>
          <td></td>
          <td id="totalPln">0.00 PLN</td>
        </tr>
      </tfoot>
    </table>

    <canvas id="categoryChart" height="100"></canvas>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://rwmwsaxlqblvnhfyuuqg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
    );

    let adminStock = [], plStock = [];

    async function fetchData() {
      const [{ data: adminData }, { data: plData }] = await Promise.all([
        supabase.from('stock').select('*'),
        supabase.from('pl_stock').select('*')
      ]);
      adminStock = adminData || [];
      plStock = plData || [];
      populateCategoryFilter();
      renderTable();
    }

    function getTotalQty(name) {
      const admin = adminStock.find(p => p.name === name);
      const pl = plStock.find(p => p.name === name);
      return (admin?.qty || 0) + (pl?.qty || 0);
    }

    function populateCategoryFilter() {
      const categories = [...new Set(adminStock.map(p => p.category))];
      const select = document.getElementById('categoryFilter');
      select.innerHTML = '<option value="">All Categories</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function renderTable() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const category = document.getElementById('categoryFilter').value;
      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = '';
      let totalUSD = 0, totalPLN = 0;

      const merged = adminStock.map(admin => {
        const pl = plStock.find(p => p.name === admin.name);
        const qty_pl = pl?.qty || 0;
        const total_qty = admin.qty + qty_pl;
        const value_usd = total_qty * (admin.cost_usd || 0);
        const value_pln = total_qty * (admin.sell_pln || 0);

        return {
          name: admin.name,
          category: admin.category,
          qty_admin: admin.qty,
          qty_pl,
          total_qty,
          cost_usd: admin.cost_usd,
          value_usd,
          sell_pln: admin.sell_pln,
          value_pln
        };
      })
      .filter(row => row.name.toLowerCase().includes(search) && (!category || row.category === category));

      for (const row of merged) {
        tbody.innerHTML += `
          <tr>
            <td>${row.name}</td>
            <td>${row.category}</td>
            <td>${row.qty_admin}</td>
            <td>${row.qty_pl}</td>
            <td>${row.total_qty}</td>
            <td>$${row.cost_usd?.toFixed(2) || '0.00'}</td>
            <td>$${row.value_usd.toFixed(2)}</td>
            <td>${row.sell_pln?.toFixed(2) || '0.00'} PLN</td>
            <td>${row.value_pln.toFixed(2)} PLN</td>
          </tr>`;
        totalUSD += row.value_usd;
        totalPLN += row.value_pln;
      }

      document.getElementById('totalUsd').textContent = `$${totalUSD.toFixed(2)}`;
      document.getElementById('totalPln').textContent = `${totalPLN.toFixed(2)} PLN`;
      renderChart(merged);
    }

    function renderChart(data) {
      const ctx = document.getElementById('categoryChart').getContext('2d');
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.category]) grouped[row.category] = 0;
        grouped[row.category] += row.value_pln;
      });

      const chartData = {
        labels: Object.keys(grouped),
        datasets: [{
          label: 'Inventory Value (PLN)',
          data: Object.values(grouped),
          backgroundColor: '#7ee2f6'
        }]
      };

      if (window.barChart) window.barChart.destroy();
      window.barChart = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', fetchData);
  </script>
</body>
</html>
