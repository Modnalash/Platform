<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Manage Stock</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { margin:0; font-family: 'Inter', sans-serif; background:#0b1c2c; color:#fff; }
    .container { padding:2rem; }
    h1 { text-align:center; margin-bottom:1rem; }
    .controls { display:flex; gap:1rem; margin-bottom:1rem; }
    .controls input, .controls select, .controls button {
      padding:.5rem 1rem; border-radius:4px; border:none; font-size:1rem;
    }
    .controls input { flex:1; }
    .controls select { width:8rem; }
    .controls button { background:#00a8e8; color:#fff; cursor:pointer; }
    table { width:100%; border-collapse:collapse; background:#1b263b; }
    th, td {
      padding:.75rem 1rem; text-align:left;
      border-bottom:1px solid #2b3a50;
    }
    th { background:#112d4e; }
    td input[type=number] {
      width:4rem; padding:.25rem; border-radius:4px; border:none;
    }
    .actions button {
      margin-right:.5rem; padding:.5rem .75rem; border:none; border-radius:4px;
      cursor:pointer; color:#fff;
    }
    .btn-add   { background:#3fbc5f; }
    .btn-delete{ background:#f44336; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Manage Stock</h1>
    <div class="controls">
      <input id="searchInput" type="text" placeholder="Search by product‚Ä¶"/>
      <select id="categoryFilter">
        <option value="all">All</option>
        <option value="Lashes">Lashes</option>
        <option value="Accessories">Accessories</option>
        <option value="Make-up">Make-up</option>
      </select>
      <button id="exportCsv">üìÅ Export CSV</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Category</th>
          <th>Quantity</th>
          <th>Add Qty</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="stockTableBody"></tbody>
    </table>
  </div>

  <script>
    // --- initialize Supabase client
    const supabase = supabase.createClient(
      'https://rwmwsaxlqblvnhfyuuqg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
    );

    // --- state
    let stockData = [];      // full table, in stable order
    let searchTerm = '';
    let categoryTerm = 'all';

    // --- fetch & store full stock table once
    async function loadStock(){
      const { data, error } = await supabase
        .from('stock')
        .select('*')
        .order('id',{ascending:true});
      if(error) return alert('Error loading stock: '+error.message);
      stockData = data;
      renderTable();
    }

    // --- render only filtered rows
    function renderTable(){
      const tbody = document.getElementById('stockTableBody');
      tbody.innerHTML = '';
      stockData
        .filter(item=>{
          return item.name.toLowerCase().includes(searchTerm)
              && (categoryTerm==='all' || item.category===categoryTerm);
        })
        .forEach(item=>{
          const tr = document.createElement('tr');
          tr.dataset.id = item.id;
          tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td class="qty-cell">${item.qty}</td>
            <td><input type="number" min="0" value="0" class="add-input"/></td>
            <td class="actions">
              <button class="btn-add">Add</button>
              <button class="btn-delete">Delete</button>
            </td>
          `;
          // Add button
          tr.querySelector('.btn-add').onclick = () => {
            const input = tr.querySelector('.add-input');
            const toAdd = parseInt(input.value) || 0;
            if(toAdd <= 0) return alert('Enter a positive number');
            // update supabase
            supabase.from('stock')
              .update({ qty: item.qty + toAdd })
              .eq('id', item.id)
              .then(({error})=>{
                if(error) return alert('Add failed: '+error.message);
                // update local state + DOM
                item.qty += toAdd;
                tr.querySelector('.qty-cell').innerText = item.qty;
                input.value = 0;
              });
          };
          // Delete button
          tr.querySelector('.btn-delete').onclick = () => {
            if(!confirm(`Delete "${item.name}"?`)) return;
            supabase.from('stock')
              .delete().eq('id',item.id)
              .then(({error})=>{
                if(error) return alert('Delete failed: '+error.message);
                // remove locally + DOM
                stockData = stockData.filter(i=>i.id!==item.id);
                tr.remove();
              });
          };
          tbody.appendChild(tr);
        });
    }

    // --- wire up filters
    document.getElementById('searchInput').addEventListener('input', e=>{
      searchTerm = e.target.value.toLowerCase();
      renderTable();
    });
    document.getElementById('categoryFilter').addEventListener('change', e=>{
      categoryTerm = e.target.value;
      renderTable();
    });

    // --- CSV export of visible rows
    document.getElementById('exportCsv').onclick = () => {
      const rows = Array.from(document.querySelectorAll('#stockTableBody tr'))
        .map(tr=>{
          const [name,cat,qty] = [...tr.children].slice(0,3).map(td=>td.innerText);
          return `${name},${cat},${qty}`;
        });
      const csv = ['Product,Category,Quantity', ...rows].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'stock_export.csv';
      a.click();
    };

    // --- initial load
    loadStock();
  </script>
</body>
</html>
