<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MODNA Admin ‚Ä¢ Manage Stock</title>
  <!-- Your existing styles here -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="sidebar">
    <h1>MODNA Admin</h1>
    <button onclick="goTo('dashboard.html')" class="nav-btn">Dashboard</button>
    <button class="nav-btn active">Manage Stock</button>
    <button onclick="goTo('order-history.html')" class="nav-btn">Order History</button>
    <button onclick="goTo('report.html')" class="nav-btn">Report</button>
    <button onclick="logout()" class="nav-btn">Logout</button>
  </div>

  <div class="main-content">
    <h2>Manage Stock</h2>
    <button id="exportBtn">üì• Export Stock</button>

    <div class="current-stock">
      <h3>Current Stock</h3>
      <table id="stockTable">
        <thead>
          <tr><th>Product</th><th>Category</th><th>Quantity</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="add-product">
      <h3>Add New Product</h3>
      <input id="newName" type="text" placeholder="Product name">
      <select id="newCategory">
        <option value="" disabled selected>Select category</option>
        <option value="Lashes">Lashes</option>
        <option value="Accessories">Accessories</option>
      </select>
      <input id="newQty" type="number" placeholder="Quantity">
      <button onclick="addProduct()">Add Product</button>
    </div>
  </div>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== Navigation =====
    function goTo(path) {
      window.location.href = path;
    }
    function logout() {
      supabase.auth.signOut()
        .then(() => goTo('login.html'))
        .catch(err => alert('Logout failed'));
    }

    // ===== Load Initial Stock =====
    async function loadStock() {
      let { data, error } = await supabase
        .from('stock')
        .select('id, name, category, qty');
      if (error) return console.error(error);
      let tbody = document.querySelector('#stockTable tbody');
      tbody.innerHTML = '';
      data.forEach(item => {
        let tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>${item.qty}</td>
          <td><button onclick="deleteStock(${item.id})">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===== Add Product Function =====
    async function addProduct() {
      const name = document.getElementById('newName').value.trim();
      const cat = document.getElementById('newCategory').value;
      const qty = parseInt(document.getElementById('newQty').value, 10);

      if (!name || !cat || isNaN(qty) || qty < 1) {
        return alert('Please fill all fields with valid values.');
      }

      const { error } = await supabase
        .from('stock')
        .insert([{ name, category: cat, qty }]);

      if (error) {
        console.error(error);
        alert('Failed to add product.');
      } else {
        document.getElementById('newName').value = '';
        document.getElementById('newCategory').value = '';
        document.getElementById('newQty').value = '';
        loadStock(); // refresh table
      }
    }

    // ===== Delete Stock Item =====
    async function deleteStock(id) {
      if (!confirm('Are you sure you want to delete this item?')) return;
      const { error } = await supabase
        .from('stock')
        .delete()
        .eq('id', id);
      if (error) {
        console.error(error);
        alert('Delete failed');
      } else loadStock();
    }

    // ===== Export Stock to CSV =====
    document.getElementById('exportBtn').onclick = () => {
      const table = document.getElementById('stockTable');
      let rows = [];
      table.querySelectorAll('tr').forEach(tr => {
        let cols = [...tr.querySelectorAll('th,td')].map(cell => `"${cell.textContent.replace(/"/g, '""')}"`);
        rows.push(cols.join(','));
      });
      const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'stock.csv';
      a.click();
      URL.revokeObjectURL(url);
    };

    // ===== Initialize on Load =====
    window.onload = () => {
      loadStock();
    };
  </script>
</body>
</html>
