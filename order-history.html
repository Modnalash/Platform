<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Order History</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background: #112233; color: #fff; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; }
    .header { background: #243d5a; padding: 32px 0 16px 0; text-align: center; font-size: 2.2rem; }
    .container { max-width: 900px; margin: 36px auto; }
    .order-group { background: #223044; border-radius: 18px; margin-bottom: 28px; padding: 32px 28px; box-shadow: 0 6px 20px #0002;}
    .order-id { font-size: 1.35rem; margin-bottom: 12px; font-weight: bold;}
    ul { margin-top: 0; }
    li { margin-bottom: 4px; font-size: 1.12rem;}
    .actions { margin-top: 18px; }
    button, .print-btn {
      font-size: 1.02rem; border: none; border-radius: 9px; padding: 8px 22px;
      cursor: pointer; margin-right: 12px; transition: background .15s;
    }
    .fulfilled-btn { background: #179a57; color: #fff; }
    .pending-btn { background: #1c88cc; color: #fff; }
    .fulfilled-btn[disabled] { opacity: 0.7; cursor: not-allowed; }
    .print-btn { background: #30b7e3; color: #fff;}
  </style>
</head>
<body>
  <div class="header">Order History</div>
  <div class="container" id="orders-container">
    <!-- Orders go here -->
  </div>

  <script>
    // CONFIG â€” CHANGE THESE
    const SUPABASE_URL = https://rwmwsaxlqblvnhfyuuqg.supabase.co;
    const SUPABASE_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y;
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function fetchOrders() {
      // Fetch all orders, newest first
      let { data: orders, error } = await supabase
        .from('orders')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) { alert('Error loading orders'); return []; }
      return orders;
    }

    function groupOrdersById(orders) {
      // Group orders by order_group_id (or id fallback)
      const groups = {};
      for (const order of orders) {
        const groupId = order.order_group_id || order.id;
        if (!groups[groupId]) groups[groupId] = [];
        groups[groupId].push(order);
      }
      return groups;
    }

    function renderOrders(groups) {
      const container = document.getElementById('orders-container');
      container.innerHTML = '';
      const groupIds = Object.keys(groups);
      if (groupIds.length === 0) {
        container.innerHTML = "<div style='padding:40px;text-align:center;'>No orders found.</div>";
        return;
      }

      groupIds.forEach(groupId => {
        const orders = groups[groupId];
        // For group display, just use first item as header
        const status = orders.every(o => o.status === 'Fulfilled') ? 'Fulfilled' : 'Pending';
        const isFulfilled = status === 'Fulfilled';
        const orderHtml = `
          <div class="order-group">
            <div class="order-id">Order #${groupId.slice(0, 8)}</div>
            <ul>
              ${orders.map(o =>
                `<li>
                  ${o.product} (${o.region}) - Qty: ${o.qty} - <span style="color:${o.status==='Fulfilled'?'#29f469':'#ffe366'}">${o.status}</span>
                </li>`).join('')}
            </ul>
            <div class="actions">
              <button class="${isFulfilled ? 'fulfilled-btn' : 'pending-btn'}" 
                onclick="markGroup('${groupId}')" ${isFulfilled ? 'disabled' : ''}>
                &#10003; ${isFulfilled ? 'Fulfilled' : 'Mark Fulfilled'}
              </button>
              <button class="print-btn" onclick="printOrder('${groupId}')">&#128438; Print</button>
            </div>
          </div>
        `;
        container.innerHTML += orderHtml;
      });
    }

    async function markGroup(groupId) {
      // Set all items in group to Fulfilled
      const { error } = await supabase
        .from('orders')
        .update({ status: 'Fulfilled' })
        .eq('order_group_id', groupId);
      if (error) {
        alert('Could not mark as Fulfilled!');
        return;
      }
      // Re-render orders
      loadOrders();
    }

    function printOrder(groupId) {
      // Just print the group card (simplified)
      const orderCard = [...document.querySelectorAll('.order-group')]
        .find(card => card.innerHTML.includes(groupId.slice(0, 8)));
      if (orderCard) {
        const win = window.open('', '', 'width=800,height=600');
        win.document.write(`<html><head><title>Order #${groupId}</title></head><body>${orderCard.innerHTML}</body></html>`);
        win.print();
      }
    }

    async function loadOrders() {
      const orders = await fetchOrders();
      const groups = groupOrdersById(orders);
      renderOrders(groups);
    }

    window.markGroup = markGroup; // expose for inline handler
    window.printOrder = printOrder;
    loadOrders();
  </script>
</body>
</html>
