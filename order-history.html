<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order History</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { margin:0; font-family:Segoe UI,sans-serif; background:#0b1c2c; color:#fff; }
    .container { display:flex; height:100vh; }
    .sidebar {
      width:250px; background:#112b44; padding:2rem 1rem;
      display:flex; flex-direction:column; gap:1rem;
    }
    .sidebar h2 { color:#7ee2f6; margin:0 0 1rem; }
    .sidebar a {
      color:#fff; text-decoration:none; padding:.75rem 1rem;
      border-radius:6px;
    }
    .sidebar a.active,
    .sidebar a:hover { background:#1e3d5e; }
    .main { flex:1; padding:2rem; overflow:auto; }
    .header {
      background:#1e3d5e; padding:1rem; border-radius:8px;
      margin-bottom:1rem; text-align:center; font-size:1.5rem;
    }
    table {
      width:100%; border-collapse:collapse; background:#1a2b3e;
      border-radius:8px; overflow:hidden;
    }
    th,td {
      padding:.75rem 1rem; border-bottom:1px solid #22303f;
      text-align:left;
    }
    th { background:#112b44; }
    button {
      padding:.5rem .75rem; border:none; border-radius:4px;
      cursor:pointer; font-size:1rem;
    }
    .btn-fulfill   { background:#06d6a0; color:#0b1c2c; }
    .btn-fulfill[disabled] { opacity:.6; cursor:default; }
    .btn-print     { background:#48cae4; color:#0b1c2c; margin-left:.5rem; }
  </style>
</head>
<body>

  <div class="container">
    <nav class="sidebar">
      <h2>MODNA Admin</h2>
      <a href="dashboard-admin.html">Dashboard</a>
      <a href="manage-stock.html">Manage Stock</a>
      <a href="order-history.html" class="active">Order History</a>
      <a href="report.html">Report</a>
      <a href="index.html">Logout</a>
    </nav>

    <main class="main">
      <div class="header">Order History</div>
      <table id="ordersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Region</th>
            <th>Product</th>
            <th>Qty</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </main>
  </div>

  <script>
    // â€” Supabase config â€” 
    const SUPABASE_URL = 'https://rwmwsaxlqblvnhfyuuqg.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // load + display all orders
    async function loadOrders() {
      const { data, error } = await supabase
        .from('orders')
        .select('id, region, product, qty, status, created_at')
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';
      data.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.region}</td>
          <td>${o.product}</td>
          <td>${o.qty}</td>
          <td>${o.status}</td>
          <td>${new Date(o.created_at).toLocaleString()}</td>
          <td>
            <button class="btn-fulfill" ${o.status==='Fulfilled'?'disabled':''}
                    onclick="fulfill(${o.id})">
              âœ” ${o.status==='Fulfilled'?'Done':'Fulfill'}
            </button>
            <button class="btn-print" onclick="printOrder(${o.id})">
              ðŸ–¨ Print
            </button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // mark single order fulfilled
    async function fulfill(id) {
      const { error } = await supabase
        .from('orders')
        .update({ status: 'Fulfilled' })
        .eq('id', id);

      if (error) alert('Update failed: '+error.message);
      else loadOrders();
    }

    // print that row
    async function printOrder(id) {
      // find row in table
      const row = [...document.querySelectorAll('#ordersTable tbody tr')]
        .find(r => r.cells[0].innerText == id);
      if (!row) return;
      const html = `
        <h2>Order #${id}</h2>
        <p><strong>Region:</strong> ${row.cells[1].innerText}</p>
        <p><strong>Product:</strong> ${row.cells[2].innerText}</p>
        <p><strong>Qty:</strong> ${row.cells[3].innerText}</p>
        <p><strong>Status:</strong> ${row.cells[4].innerText}</p>
        <p><strong>Date:</strong> ${row.cells[5].innerText}</p>
      `;
      const w = window.open('', '_blank');
      w.document.write(`<html><body style="font-family:Arial;">${html}</body></html>`);
      w.document.close();
      w.print();
    }

    document.addEventListener('DOMContentLoaded', loadOrders);
  </script>
</body>
</html>
