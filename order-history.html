
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grouped Order History</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background: #0b1c2c; color: white; font-family: sans-serif; padding: 20px; }
    h2 { color: #7dd3fc; }
    .order { background: #1e3a5f; padding: 1rem; margin: 1rem 0; border-radius: 8px; }
    .fulfilled { background-color: #1b4332 !important; }
    button { margin-right: 10px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    .mark { background: #06d6a0; color: black; }
    .print { background: #48cae4; color: black; }
  </style>
</head>
<body>
  <h1>Grouped Order History</h1>
  <div id="orders"></div>

<script>
const supabase = window.supabase.createClient(
  'https://rwmwsaxlqblvnhfyuuqg.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
);

async function loadOrders() {
  const {{ data }} = await supabase.from('orders').select('*').order('created_at', {{ ascending: false }});
  const grouped = data.reduce((acc, order) => {{
    if (!acc[order.order_group_id]) acc[order.order_group_id] = [];
    acc[order.order_group_id].push(order);
    return acc;
  }}, {{}});

  const container = document.getElementById('orders');
  container.innerHTML = '';
  Object.entries(grouped).forEach(([groupId, orders]) => {{
    const status = orders.every(o => o.status === 'Fulfilled') ? 'Fulfilled' : 'Pending';
    const block = document.createElement('div');
    block.className = 'order' + (status === 'Fulfilled' ? ' fulfilled' : '');
    block.innerHTML = `
      <h2>Order #${groupId.slice(0, 8)}... - ${status}</h2>
      <ul>
        ${orders.map(o => `<li>${o.product} (${o.region}) - Qty: ${o.qty}</li>`).join('')}
      </ul>
      <button class="mark" onclick="markGroup('${groupId}')">Mark Fulfilled</button>
      <button class="print" onclick="printGroup('${groupId}')">ðŸ–¨ Print</button>
    `;
    container.appendChild(block);
  }});
}}

async function markGroup(groupId) {{
  await supabase.from('orders').update({{ status: 'Fulfilled' }}).eq('order_group_id', groupId);
  loadOrders();
}}

function printGroup(groupId) {{
  const el = [...document.querySelectorAll('.order')].find(div => div.innerHTML.includes(groupId.slice(0, 8)));
  const win = window.open('', '_blank');
  win.document.write('<html><head><title>Print Order</title></head><body>' + el.innerHTML + '</body></html>');
  win.document.close();
  win.print();
}}

document.addEventListener("DOMContentLoaded", loadOrders);
</script>
</body>
</html>
