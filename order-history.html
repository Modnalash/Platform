<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Order History</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#0b1c2c; color:#fff; }
    .container { display:flex; height:100vh; }
    .sidebar {
      width:250px; background:#112b44; padding:2rem 1rem;
      display:flex; flex-direction:column; gap:1rem;
    }
    .sidebar h2 { margin:0 0 1rem; color:#7ee2f6; }
    .sidebar a {
      color:#fff; text-decoration:none; padding:.75rem 1rem; border-radius:6px;
    }
    .sidebar a.active, .sidebar a:hover { background:#1e3d5e; }
    .main { flex:1; padding:2rem; overflow-y:auto; }
    .header {
      background:#1e3d5e; padding:1rem; border-radius:8px;
      margin-bottom:1rem; text-align:center; font-size:1.5rem;
    }
    .order-block {
      background:#1a2b3e; border-radius:8px; padding:1rem 1.5rem;
      margin-bottom:1rem;
    }
    .order-block.fulfilled { opacity:.6; }
    .order-block h3 { margin-top:0; font-size:1.25rem; }
    .order-block ul { margin:0.5rem 0 1rem 1.25rem; }
    .order-block li { margin-bottom:.5rem; }
    button {
      padding:.5rem .75rem; border:none; border-radius:4px;
      cursor:pointer; font-size:1rem; margin-right:.5rem;
    }
    .btn-fulfill   { background:#06d6a0; color:#0b1c2c; }
    .btn-fulfill[disabled] { opacity:.6; cursor:default; }
    .btn-print     { background:#48cae4; color:#0b1c2c; }
  </style>
</head>
<body>

<div class="container">
  <nav class="sidebar">
    <h2>MODNA Admin</h2>
    <a href="dashboard-admin.html">Dashboard</a>
    <a href="manage-stock.html">Manage Stock</a>
    <a href="order-history.html" class="active">Order History</a>
    <a href="report.html">Report</a>
    <a href="index.html">Logout</a>
  </nav>

  <main class="main">
    <div class="header">Order History</div>
    <div id="ordersContainer">
      <!-- orders will be injected here -->
    </div>
  </main>
</div>

<script>
  const SUPABASE_URL = 'https://rwmwsaxlqblvnhfyuuqg.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // fetch & group
  async function loadOrders() {
    const { data: rows, error } = await supabase
      .from('orders')
      .select('order_group_id,region,product,category,qty,status,created_at')
      .order('created_at', { ascending: false });

    const container = document.getElementById('ordersContainer');
    container.innerHTML = '';

    if (error) {
      container.innerHTML = `<p style="color:#f66">Error loading orders</p>`;
      console.error(error);
      return;
    }
    if (!rows.length) {
      container.innerHTML = `<p>No orders yet</p>`;
      return;
    }

    // group by order_group_id
    const groups = {};
    rows.forEach(o => {
      if (!o.order_group_id) return;
      groups[o.order_group_id] ||= [];
      groups[o.order_group_id].push(o);
    });

    // render each
    for (const [gid, items] of Object.entries(groups)) {
      const allFulfilled = items.every(i => i.status === 'Fulfilled');
      const block = document.createElement('div');
      block.className = 'order-block' + (allFulfilled ? ' fulfilled' : '');

      // earliest timestamp
      const date = new Date(Math.min(...items.map(i=>new Date(i.created_at))));
      const dateStr = date.toLocaleString();

      block.innerHTML = `
        <h3>Order #${gid.slice(0,8)}${allFulfilled?' - âœ… Fulfilled':''}</h3>
        <p><small><em>${dateStr}</em></small></p>
        <ul>
          ${items.map(i =>
            `<li>${i.product} (${i.category}) â€” Qty: ${i.qty} â€” ${i.region} â€” ${i.status}</li>`
          ).join('')}
        </ul>
        <button class="btn-fulfill" ${allFulfilled?'disabled':''}
                onclick="fulfill('${gid}')">
          âœ” ${allFulfilled?'Done':'Fulfill'}
        </button>
        <button class="btn-print" onclick="printOrder('${gid}')">
          ðŸ–¨ Print
        </button>
      `;
      container.appendChild(block);
    }
  }

  // fulfill by group_id only
  async function fulfill(gid) {
    const { error } = await supabase
      .from('orders')
      .update({ status: 'Fulfilled' })
      .eq('order_group_id', gid);

    if (error) {
      alert('âŒ Update failed: '+error.message);
      console.error(error);
    } else {
      loadOrders();
    }
  }

  // print the HTML from that block
  function printOrder(gid) {
    const block = [...document.querySelectorAll('.order-block')]
      .find(b => b.querySelector('h3').innerText.includes(gid.slice(0,8)));
    if (!block) return;
    const w = window.open('', '_blank');
    w.document.write(`<html><body style="font-family:Arial;padding:2rem;">${block.innerHTML}</body></html>`);
    w.document.close();
    w.print();
  }

  document.addEventListener('DOMContentLoaded', loadOrders);
</script>

</body>
</html>
