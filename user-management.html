<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/lucide-static@0.308.0/font/lucide.css" rel="stylesheet" />
  <style>
    body {
      margin: 0; background: #0e2536; color: #c3f5ff; font-family: 'Inter', sans-serif;
    }
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0; width: 240px; background: #09202b; padding: 36px 0 0 0;
      border-right: 1.5px solid #18324b; z-index: 10; min-height: 100vh;
    }
    .sidebar h2 {
      font-size: 2.2rem; color: #51e5ff; margin: 0 0 36px 36px; letter-spacing: 1px;
      font-family: serif; font-weight: 700;
    }
    .sidebar a {
      display: block; padding: 16px 36px; color: #c3f5ff; text-decoration: none; font-size: 1.15rem;
      border-left: 3px solid transparent; transition: background 0.18s, color 0.18s;
    }
    .sidebar a.active, .sidebar a:hover {
      background: #163650; color: #51e5ff; border-left: 3px solid #51e5ff;
    }
    .logout-btn {
      display: block; margin: 48px 36px 0 36px; width: 90%; padding: 12px;
      background: #142c42; color: #c3f5ff; border: none; border-radius: 8px; cursor: pointer;
      font-size: 1.05rem; font-weight: 600; transition: background 0.2s;
    }
    .logout-btn:hover { background: #24597e; color: #fff; }

    .main-content {
      margin-left: 260px; padding: 32px 44px 48px 44px; min-height: 100vh; background: radial-gradient(circle at top right,#1d4564 20%, #0e2536 85%);
    }
    .main-content h1 {
      font-family: serif; font-size: 2.6rem; margin-top: 0; color: #e4f8ff;
      background: linear-gradient(90deg, #51e5ff 30%, #e4f8ff 60%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .main-content p { font-size: 1.18rem; color: #90eaff; margin-bottom: 2.5rem; }

    .search-bar {
      display: block; width: 340px; max-width: 100%; padding: 13px 18px;
      border-radius: 8px; background: #163650; color: #b3e8ff; border: 1px solid #244e66;
      font-size: 1.08rem; margin-bottom: 30px; outline: none;
    }
    .search-bar:focus { border-color: #51e5ff; }

    .table-container {
      background: rgba(18,43,63,0.82); border-radius: 18px; padding: 12px 0 8px 0;
      box-shadow: 0 6px 40px 0 #0a2237b3; overflow-x: auto; min-width: 100px;
    }
    table { border-collapse: collapse; width: 100%; }
    th, td { text-align: left; padding: 14px 16px; font-size: 1.07rem; }
    th { color: #3fefff; font-weight: 700; letter-spacing: .02em; border-bottom: 2px solid #2be0f8; }
    tr:not(:last-child) { border-bottom: 1px solid #1c3957; }
    td { color: #fff; }
    .user-status.active {
      background: #083e2c; color: #42ffad; font-weight: 700; border-radius: 7px; padding: 3px 13px; font-size: 1.01rem;
      border: 1.5px solid #16e796;
    }
    .user-status.blocked {
      background: #451f2a; color: #ff5177; font-weight: 700; border-radius: 7px; padding: 3px 13px;
      font-size: 1.01rem; border: 1.5px solid #ff6c8f;
    }
    .user-actions button {
      background: none; border: none; cursor: pointer; padding: 0 10px; font-size: 1.25em; color: #51e5ff;
      transition: color 0.15s;
    }
    .user-actions button:hover { color: #15f1d9; }
    @media (max-width: 900px) {
      .main-content { margin-left: 0; padding: 20px 2vw; }
      .sidebar { position: static; width: 100%; min-height: unset; border-right: none; padding: 20px 0 0 0;}
      .sidebar h2 { margin: 0 0 24px 18px; font-size: 1.45rem; }
      .sidebar a { padding: 13px 18px; font-size: 1rem;}
    }
    /* Modal styles */
    .modal-bg {
      display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(16,36,56,0.66);
      z-index: 2000; align-items: center; justify-content: center;
    }
    .modal {
      background: #193a4e; padding: 36px 38px 26px 38px; border-radius: 16px; width: 340px;
      box-shadow: 0 8px 60px #0033548a;
      color: #d8f6ff; text-align: left;
    }
    .modal label { font-size: 1.08rem; font-weight: 600; color: #58e4ff; margin-bottom: 7px; display: block; }
    .modal input, .modal select {
      width: 100%; padding: 9px; border-radius: 7px; border: 1.5px solid #244e66;
      margin-bottom: 15px; background: #112939; color: #e7fcff; font-size: 1.04rem; outline: none;
    }
    .modal button {
      background: #51e5ff; color: #05394e; border: none; border-radius: 8px;
      font-weight: bold; font-size: 1.06rem; padding: 10px 0; cursor: pointer; width: 100%;
      margin-top: 5px; transition: background 0.17s;
    }
    .modal button:hover { background: #17e6ad; }
    .modal .close-btn {
      background: none; color: #79ebff; font-size: 1.25rem; position: absolute; right: 24px; top: 19px; cursor: pointer; border: none;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Super Admin</h2>
    <a href="superadmin-dashboard.html">Dashboard</a>
    <a href="audit-log.html">Audit Log</a>
    <a href="user-management.html" class="active">User Management</a>
    <a href="#">All Orders</a>
    <a href="#">All Stock</a>
    <a href="#">Platform Settings</a>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
  <div class="main-content">
    <h1>User Management</h1>
    <p>Manage all platform users, roles, and access in one place.</p>
    <input class="search-bar" type="text" placeholder="Search users..." id="searchInput">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Role</th>
            <th>Status</th>
            <th>Last Login</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <tr><td colspan="7" style="color:#ff9292;text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-bg" id="edit-modal-bg">
    <div class="modal">
      <button class="close-btn" onclick="closeEditModal()" title="Close">&times;</button>
      <form id="edit-user-form">
        <label for="edit-role">Role</label>
        <select id="edit-role">
          <option value="pl">PL</option>
          <option value="uk">UK</option>
          <option value="admin">Admin</option>
          <option value="superadmin">Super Admin</option>
        </select>
        <label for="edit-status">Status</label>
        <select id="edit-status">
          <option value="active">Active</option>
          <option value="blocked">Blocked</option>
        </select>
        <button type="submit">Update User</button>
      </form>
    </div>
  </div>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://rwmwsaxlqblvnhfyuugq.supabase.co',
      'YOUR_ANON_KEY_HERE' // <-- replace with your anon/public key!
    );

    let usersAll = [];
    let editingUserId = null;

    async function checkSuperadminAccessAndLoadUsers() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        window.location.href = "index.html";
        return;
      }
      // Get role from your profiles table
      const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
      if (!profile || profile.role !== "superadmin") {
        window.location.href = "index.html";
        return;
      }
      loadUsers();
    }

    async function loadUsers() {
      let { data: users, error } = await supabase
        .from('profiles')
        .select('id, email, role, status, created')
        .order('created', { ascending: false });

      if (error) {
        document.getElementById("userTableBody").innerHTML = `<tr><td colspan="7" style="color:#ff9292;text-align:center;">Error loading users: ${error.message}</td></tr>`;
        return;
      }

      // Optionally get last login info if you have this info stored elsewhere
      usersAll = users;
      displayUsers(usersAll);
    }

    function displayUsers(users) {
      const tbody = document.getElementById("userTableBody");
      if (!users.length) {
        tbody.innerHTML = `<tr><td colspan="7" style="color:#ff9292;text-align:center;">No users found.</td></tr>`;
        return;
      }
      tbody.innerHTML = "";
      users.forEach(user => {
        tbody.innerHTML += `
          <tr>
            <td>${user.email || "-"}</td>
            <td>${user.name || "-"}</td>
            <td>${user.role || "-"}</td>
            <td><span class="user-status ${user.status || "active"}">${user.status === "blocked" ? "Blocked" : "Active"}</span></td>
            <td>${user.last_login ? new Date(user.last_login).toLocaleString() : "-"}</td>
            <td>${user.created ? new Date(user.created).toLocaleDateString() : "-"}</td>
            <td class="user-actions">
              <button class="user-action-btn" title="Edit" onclick='openEditModal("${user.id}")'><i class="lucide lucide-pencil"></i></button>
              <button class="user-action-btn" title="${user.status === "blocked" ? "Unblock" : "Block"}" onclick='toggleBlockUser("${user.id}", "${user.status}")'><i class="lucide ${user.status === "blocked" ? "lucide-lock" : "lucide-unlock"}"></i></button>
            </td>
          </tr>
        `;
      });
    }

    // Search
    document.getElementById('searchInput').oninput = function () {
      const value = this.value.toLowerCase();
      displayUsers(usersAll.filter(u =>
        (u.email || "").toLowerCase().includes(value) ||
        (u.role || "").toLowerCase().includes(value)
      ));
    };

    // Modal logic
    window.openEditModal = function(id) {
      editingUserId = id;
      const user = usersAll.find(u => u.id === id);
      if (!user) return;
      document.getElementById('edit-role').value = user.role || "pl";
      document.getElementById('edit-status').value = user.status || "active";
      document.getElementById('edit-modal-bg').style.display = "flex";
    }
    window.closeEditModal = function() {
      document.getElementById('edit-modal-bg').style.display = "none";
      editingUserId = null;
    }

    document.getElementById('edit-user-form').onsubmit = async function(e) {
      e.preventDefault();
      if (!editingUserId) return;
      const role = document.getElementById('edit-role').value;
      const status = document.getElementById('edit-status').value;
      const { error } = await supabase
        .from('profiles')
        .update({ role, status })
        .eq('id', editingUserId);
      if (error) alert("Failed to update user: " + error.message);
      window.closeEditModal();
      await loadUsers();
    }

    window.toggleBlockUser = async function(id, status) {
      const block = status !== "blocked";
      const { error } = await supabase
        .from('profiles')
        .update({ status: block ? "blocked" : "active" })
        .eq('id', id);
      if (error) alert("Failed to update user status: " + error.message);
      await loadUsers();
    }

    function logout() {
      supabase.auth.signOut().then(() => {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "index.html";
      });
    }

    checkSuperadminAccessAndLoadUsers();
  </script>
</body>
</html>
