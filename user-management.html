<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Management | Super Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.285.0/font/lucide.css">
  <style>
    /* ... (use your latest modern sidebar + table styles here, unchanged) ... */
  </style>
</head>
<body>
  <div class="container">
    <nav class="sidebar">
      <h2>Super Admin</h2>
      <div class="sidebar-menu">
        <a href="superadmin-dashboard.html"><i class="lucide lucide-pie-chart"></i><span>Dashboard</span></a>
        <a href="audit-log.html"><i class="lucide lucide-list-checks"></i><span>Audit Log</span></a>
        <a href="user-management.html" class="active"><i class="lucide lucide-users"></i><span>User Management</span></a>
        <a href="#"><i class="lucide lucide-receipt"></i><span>All Orders</span></a>
        <a href="#"><i class="lucide lucide-warehouse"></i><span>All Stock</span></a>
        <a href="#"><i class="lucide lucide-sliders"></i><span>Platform Settings</span></a>
      </div>
      <button class="logout-btn" onclick="logout()"><i class="lucide lucide-log-out"></i> Logout</button>
    </nav>
    <main class="main">
      <div class="header">
        <span class="hello-owner">User Management</span>
      </div>
      <div class="subtext">
        Manage all platform users, roles, and access in one place.
      </div>
      <div class="diagnostic" id="diagnostic">Checking access...</div>
      <div class="search-row">
        <input type="text" id="user-search" placeholder="Search users...">
      </div>
      <div class="user-table-container" id="user-table-container">
        <table class="user-table" id="user-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="user-table-tbody">
            <tr><td colspan="7" class="audit-empty">Loading users...</td></tr>
          </tbody>
        </table>
      </div>
    </main>
    <!-- Edit Modal -->
    <div class="edit-modal-bg" id="edit-modal-bg">
      <div class="edit-modal" id="edit-modal">
        <div class="edit-modal-title">Edit User</div>
        <form id="edit-user-form">
          <label for="edit-role">Role</label>
          <select id="edit-role">
            <option value="pl">PL</option>
            <option value="uk">UK</option>
            <option value="admin">Admin</option>
            <option value="superadmin">Superadmin</option>
          </select>
          <label for="edit-status">Status</label>
          <select id="edit-status">
            <option value="active">Active</option>
            <option value="blocked">Blocked</option>
          </select>
          <button type="submit">Save</button>
          <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
        </form>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // --- Supabase credentials ---
    const supabase = window.supabase.createClient(
      'https://rwmwsaxlqblvnhfyuuqg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3bXdzYXhscWJsdm5oZnl1dXFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NDU3OTYsImV4cCI6MjA2NTQyMTc5Nn0.gwcRLpJzsHkSVLQs0iFULIk6eAc7FlHHF9LaERlQJ6Y'
    );

    let usersAll = [];
    let filteredUsers = [];
    let editingUserId = null;

    async function checkSuperadminAccessAndLoadUsers() {
      const diag = document.getElementById("diagnostic");
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if (userError || !user) {
        diag.style.display = "block";
        diag.innerHTML = "Not logged in. Redirecting to login...";
        setTimeout(() => window.location.href = "index.html", 1200);
        return;
      }
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();
      if (profileError || !profile) {
        diag.style.display = "block";
        diag.innerHTML = "No profile found. Logging out for security...";
        setTimeout(() => { logout(); }, 1500);
        return;
      }
      if (profile.role !== "superadmin") {
        diag.style.display = "block";
        diag.innerHTML = "Access denied: you are not a superadmin. Logging out...";
        setTimeout(() => { logout(); }, 1500);
        return;
      }
      diag.style.display = "none";
      await loadUsers();
    }

    // Fetches both profile and auth user info
    async function loadUsers() {
      const tbody = document.getElementById("user-table-tbody");
      tbody.innerHTML = `<tr><td colspan="7" class="audit-empty">Loading users...</td></tr>`;

      // 1. Fetch all user profiles
      let { data: profiles, error: profileErr } = await supabase
        .from('profiles')
        .select('*')
        .order('created_at', { ascending: false });

      // 2. Fetch all auth users (for emails, last_sign_in, created_at)
      let { data: authUsers, error: authErr } = await supabase
        .from('users')
        .select('id, email, last_sign_in_at, created_at');

      if (profileErr || authErr) {
        tbody.innerHTML = `<tr><td colspan="7" class="audit-empty" style="color:#ff9eae">Error loading users: ${profileErr?.message || ''} ${authErr?.message || ''}</td></tr>`;
        return;
      }
      if (!profiles || profiles.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="audit-empty">No users found.</td></tr>`;
        return;
      }

      // Join data from profiles + auth users
      usersAll = profiles.map(profile => {
        const auth = authUsers.find(u => u.id === profile.id) || {};
        return {
          ...profile,
          email: profile.email || auth.email || "-",
          last_login: auth.last_sign_in_at || "-",
          created: auth.created_at || profile.created_at || "-",
        }
      });

      filteredUsers = usersAll;
      setupSearch();
      renderUsers();
    }

    function setupSearch() {
      const searchInput = document.getElementById("user-search");
      searchInput.oninput = function() {
        let q = searchInput.value.toLowerCase();
        filteredUsers = usersAll.filter(user =>
          (user.email?.toLowerCase().includes(q)) ||
          (user.name?.toLowerCase().includes(q))
        );
        renderUsers();
      };
    }

    function renderUsers() {
      const tbody = document.getElementById("user-table-tbody");
      tbody.innerHTML = "";
      if (filteredUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="audit-empty">No users found for your search.</td></tr>`;
        return;
      }
      filteredUsers.forEach(user => {
        tbody.innerHTML += `<tr>
          <td>${user.email || "-"}</td>
          <td>${user.name || "-"}</td>
          <td>${user.role || "-"}</td>
          <td><span class="user-status ${user.status || "active"}">${user.status === "blocked" ? "Blocked" : "Active"}</span></td>
          <td>${user.last_login && user.last_login !== "-" ? new Date(user.last_login).toLocaleString() : "-"}</td>
          <td>${user.created && user.created !== "-" ? new Date(user.created).toLocaleDateString() : "-"}</td>
          <td class="user-actions">
            <button class="user-action-btn" title="Edit" onclick='openEditModal("${user.id}")'><i class="lucide lucide-pencil"></i></button>
            <button class="user-action-btn" title="${user.status === "blocked" ? "Unblock" : "Block"}" onclick='toggleBlockUser("${user.id}", "${user.status}")'><i class="lucide ${user.status === "blocked" ? "lucide-lock" : "lucide-unlock"}"></i></button>
          </td>
        </tr>`;
      });
    }

    window.openEditModal = function(id) {
      editingUserId = id;
      const user = usersAll.find(u => u.id === id);
      if (!user) return;
      document.getElementById('edit-role').value = user.role || "pl";
      document.getElementById('edit-status').value = user.status || "active";
      document.getElementById('edit-modal-bg').style.display = "flex";
    }
    window.closeEditModal = function() {
      document.getElementById('edit-modal-bg').style.display = "none";
      editingUserId = null;
    }

    document.getElementById('edit-user-form').onsubmit = async function(e) {
      e.preventDefault();
      if (!editingUserId) return;
      const role = document.getElementById('edit-role').value;
      const status = document.getElementById('edit-status').value;
      const { error } = await supabase
        .from('profiles')
        .update({ role, status })
        .eq('id', editingUserId);
      if (error) alert("Failed to update user: " + error.message);
      window.closeEditModal();
      await loadUsers();
    }

    window.toggleBlockUser = async function(id, status) {
      const block = status !== "blocked";
      const { error } = await supabase
        .from('profiles')
        .update({ status: block ? "blocked" : "active" })
        .eq('id', id);
      if (error) alert("Failed to update user status: " + error.message);
      await loadUsers();
    }

    function logout() {
      supabase.auth.signOut().then(() => {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "index.html";
      });
    }
    checkSuperadminAccessAndLoadUsers();
  </script>
</body>
</html>
